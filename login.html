<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TDEA CRM - Login</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #F4F5F7; margin: 0; }
    /* è¦æ ¼é–å®šï¼š0 åœ“è§’ */
    * { border-radius: 0 !important; }
    .line-green-bg { background-color: #06C755; }
    .input-focus:focus { border-color: #06C755; outline: none; }
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <!-- è¼‰å…¥èˆ‡èº«åˆ†ç¢ºèªä¸­ -->
  <div id="loader" class="text-center space-y-6 fade-in">
    <div id="profilePreview" class="hidden flex flex-col items-center space-y-3">
      <img id="loadAvatar" class="w-16 h-16 border-2 border-white shadow-sm" src="" />
      <p id="loadName" class="text-gray-600 font-bold text-sm tracking-widest"></p>
    </div>
    <div class="w-10 h-10 border-4 border-gray-200 border-t-[#06C755] animate-spin mx-auto"></div>
    <p class="text-gray-400 font-bold text-[10px] uppercase tracking-[0.2em]">Verifying Identity...</p>
  </div>

  <!-- è¨»å†Šèˆ‡ç¶å®šè¡¨å–® -->
  <div id="mainForm" class="hidden w-full max-w-md bg-white border border-gray-200 shadow-sm overflow-hidden animate-in fade-in">
    <div class="p-8 border-b border-gray-100 text-center bg-[#F8F9FA]">
      <div class="relative inline-block mb-4">
        <img id="avatar" class="w-20 h-20 border border-gray-200 p-1 bg-white" src="" />
        <div class="absolute -bottom-1 -right-1 w-6 h-6 line-green-bg flex items-center justify-center text-white text-[10px] font-bold">ğŸ†”</div>
      </div>
      <h1 class="text-lg font-bold text-gray-800"><span id="name">ç”¨æˆ¶</span>ï¼Œæ‚¨å¥½</h1>
      <p class="text-[10px] text-gray-400 mt-1 uppercase tracking-widest">è«‹å®Œæˆæœƒå“¡èº«åˆ†ç¶å®š</p>
    </div>

    <div class="p-8 space-y-6">
      <div class="grid grid-cols-3 gap-px bg-gray-200 border border-gray-200">
        <button onclick="setType('association')" id="btn-assoc" class="py-3 text-xs font-bold bg-white text-gray-400">æœ¬æ¥­æœƒå“¡</button>
        <button onclick="setType('vendor')" id="btn-vendor" class="py-3 text-xs font-bold bg-white text-gray-400">å» å•†æœƒå“¡</button>
        <button onclick="setType('general')" id="btn-guest" class="py-3 text-xs font-bold bg-white text-gray-400">ä¸€èˆ¬å¤§çœ¾</button>
      </div>

      <div class="space-y-4">
        <div id="idArea">
          <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">æœƒå“¡ç·¨è™Ÿ</label>
          <input id="mid" type="text" class="w-full mt-1 border border-gray-200 px-4 py-3 text-sm input-focus" placeholder="å¦‚: Z1090001" />
        </div>
        <div>
          <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">æ‰‹æ©Ÿè™Ÿç¢¼</label>
          <input id="phone" type="tel" class="w-full mt-1 border border-gray-200 px-4 py-3 text-sm input-focus" placeholder="0912345678" />
        </div>
      </div>
      <button onclick="submitBind()" id="submitBtn" class="w-full line-green-bg text-white py-4 font-bold text-sm shadow-sm active:opacity-90 transition-all">ç¢ºèªç¶å®šä¸¦ç™»å…¥</button>
    </div>
  </div>

  <script>
    const LIFF_ID = "2005868456-Rt5YK7qL";
    const CONFIG = { GAS_URL: window.CRM_CONFIG?.GAS_URL || "" };
    let curType = "association", uid = "";

    window.onload = async () => {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        
        const p = await liff.getProfile();
        uid = p.userId;
        
        // é¡¯ç¤ºç™»å…¥è€…è³‡è¨Š
        document.getElementById('loadAvatar').src = p.pictureUrl;
        document.getElementById('loadName').textContent = p.displayName;
        document.getElementById('profilePreview').classList.remove('hidden');
        
        document.getElementById('avatar').src = p.pictureUrl;
        document.getElementById('name').textContent = p.displayName;

        if (!CONFIG.GAS_URL || CONFIG.GAS_URL === "") {
          console.warn("GAS_URL is missing, showing form for preview.");
          showForm();
          return;
        }

        // å‘¼å« API æª¢æŸ¥æ¬Šé™
        const response = await fetch(`${CONFIG.GAS_URL}?action=check&userId=${uid}`);
        const res = await response.json();
        
        if (res.status === 'admin') {
          window.location.href = "index.html";
        } else if (res.status === 'member') {
          window.location.href = "activity.html";
        } else {
          showForm();
        }
      } catch (e) { 
        console.error("Auth Error:", e);
        showForm();
      }
    };

    function showForm() {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('mainForm').classList.remove('hidden');
      setType('association');
    }

    function setType(t) {
      curType = t;
      ['assoc', 'vendor', 'guest'].forEach(id => {
        document.getElementById('btn-' + id).className = "py-3 text-xs font-bold bg-white text-gray-400";
      });
      const activeId = t === 'association' ? 'assoc' : (t === 'vendor' ? 'vendor' : 'guest');
      document.getElementById('btn-' + activeId).className = "py-3 text-xs font-black line-green-bg text-white shadow-inner";
      document.getElementById('idArea').style.display = t === 'general' ? 'none' : 'block';
    }

    async function submitBind() {
      const tel = document.getElementById('phone').value.trim();
      const mid = document.getElementById('mid').value.trim();
      if (!tel) return alert("è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼");
      if (curType !== 'general' && !mid) return alert("è«‹è¼¸å…¥æœƒå“¡ç·¨è™Ÿ");

      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.textContent = "é€£ç·šé©—è­‰ä¸­...";

      try {
        const response = await fetch(CONFIG.GAS_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'bindMember',
            userId: uid,
            type: curType,
            memberId: mid,
            phone: tel
          })
        });
        const res = await response.json();
        if (res.success) {
          alert("ç¶å®šæˆåŠŸï¼å³å°‡é€²å…¥ç³»çµ±");
          window.location.href = "activity.html";
        } else {
          alert(res.message || "é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™");
          btn.disabled = false;
          btn.textContent = "ç¢ºèªç¶å®šä¸¦ç™»å…¥";
        }
      } catch (e) {
        alert("ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦");
        btn.disabled = false;
        btn.textContent = "ç¢ºèªç¶å®šä¸¦ç™»å…¥";
      }
    }
  </script>
</body>
</html>
