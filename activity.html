<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TDEA - Member Activities</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #F4F5F7; margin: 0; }
    * { border-radius: 0 !important; }
    .line-green-bg { background-color: #06C755; }
    .line-green-text { color: #06C755; }
  </style>
</head>
<body class="bg-[#F4F5F7]">
  <nav class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
    <div class="flex items-center space-x-3">
      <div class="w-8 h-8 line-green-bg flex items-center justify-center shrink-0">
        <span class="text-white text-xs font-black">TDEA</span>
      </div>
      <span class="font-bold text-gray-800">會員專區</span>
    </div>
    <div class="flex items-center space-x-3">
      <div class="text-right">
        <div id="user" class="text-xs font-black text-gray-700 leading-none">-</div>
        <div class="text-[8px] text-gray-400 font-bold uppercase tracking-tighter">Member</div>
      </div>
      <img id="avatar" class="w-8 h-8 border border-gray-100 bg-gray-50" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" />
    </div>
  </nav>

  <div class="p-6 space-y-6">
    <div class="bg-white border border-gray-200 p-8 text-center shadow-sm">
      <h2 class="text-xl font-bold text-gray-800">最新活動列表</h2>
      <p class="text-xs text-gray-400 uppercase tracking-widest">Recent Events</p>
    </div>
    <div id="activities" class="grid grid-cols-1 gap-4">
      <div class="text-center p-10 text-gray-300 font-bold animate-pulse">FETCHING ACTIVITIES...</div>
    </div>
  </div>

  <script>
    const LIFF_ID = "2005868456-Rt5YK7qL";
    const CONFIG = { GAS_URL: window.CRM_CONFIG?.GAS_URL || "" };

    // 安全的重導向函數，防止空網址錯誤
    function safeRedirect(target) {
      if (target && target.trim() !== "") {
        window.location.href = target;
      } else {
        console.error("Redirect failed: Target URL is empty");
      }
    }

    window.onload = async () => {
      // 預覽模式判斷
      if (!CONFIG.GAS_URL || CONFIG.GAS_URL === "") {
        console.warn("PREVIEW MODE: Skipping LIFF Auth");
        document.getElementById('user').textContent = "預覽用戶";
        loadMock();
        return;
      }

      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { 
          safeRedirect("login.html"); 
          return; 
        }
        
        const p = await liff.getProfile();
        document.getElementById('avatar').src = p.pictureUrl;
        document.getElementById('user').textContent = p.displayName;

        loadActivities();
      } catch (e) { 
        console.error("LIFF Initialization failed:", e);
        safeRedirect("login.html"); 
      }
    };

    async function loadActivities() {
      try {
        const response = await fetch(`${CONFIG.GAS_URL}?action=getActivities`);
        if (!response.ok) throw new Error("Network response was not ok");
        
        const res = await response.json();
        const container = document.getElementById('activities');
        container.innerHTML = "";
        
        if (res.success && res.data && res.data.length > 0) {
          res.data.forEach(act => {
            const card = document.createElement('div');
            card.className = "bg-white border border-gray-200 p-6 flex justify-between items-center hover:border-[#06C755] transition-all cursor-pointer group";
            card.innerHTML = `
              <div>
                <div class="text-[10px] font-bold text-gray-400 mb-1">${act['活動性質'] || '一般'}</div>
                <div class="text-lg font-bold text-gray-800 group-hover:line-green-text transition-colors">${act['活動名稱'] || '未命名'}</div>
                <div class="text-xs text-gray-500 mt-1">${act['活動時間'] || ''}</div>
              </div>
              <button class="line-green-bg text-white px-6 py-2 text-xs font-bold shadow-sm active:scale-95 transition-all">立即參加</button>
            `;
            container.appendChild(card);
          });
        } else { 
          container.innerHTML = `<div class="p-10 text-center text-gray-400 font-bold uppercase text-xs">No active events at the moment</div>`; 
        }
      } catch (err) {
        console.error("Failed to load activities:", err);
        document.getElementById('activities').innerHTML = `<div class="p-10 text-center text-red-400 font-bold">連線失敗，請稍後再試</div>`;
      }
    }

    function loadMock() { 
      document.getElementById('activities').innerHTML = `<div class="bg-white border border-gray-200 p-10 text-center text-gray-400 font-bold">— PREVIEW MODE —</div>`; 
    }
  </script>
</body>
</html>
