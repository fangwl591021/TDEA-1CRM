<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM 企業管理系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
    
    body { 
      font-family: 'Inter', 'Noto Sans TC', sans-serif; 
      background-color: #ffffff; 
      color: #333;
      margin: 0;
    }

    /* 規格鎖定：全域取消圓角 (Ragic Style) */
    * { border-radius: 0 !important; }

    .line-green { background-color: #06C755; }
    
    /* 側邊欄樣式 - 專業深色 */
    .sidebar-bg { background-color: #1a1a1a; }
    .sidebar-item:hover { background-color: #2a2a2a; }
    .sidebar-active { background-color: #06C755 !important; color: #fff !important; }

    /* 表格樣式 - 高密度 Ragic Style */
    .crm-table { width: 100%; border-collapse: collapse; }
    .crm-table th { 
      background-color: #f1f3f5; 
      border: 1px solid #dee2e6; 
      padding: 10px 12px; 
      font-size: 13px; 
      font-weight: 700;
      color: #495057;
      text-align: left;
    }
    .crm-table td { 
      border: 1px solid #dee2e6; 
      padding: 8px 12px; 
      font-size: 13px;
      white-space: nowrap;
    }
    .crm-table tr:hover { background-color: #f8f9fa; }

    /* 詳細資料格線佈局 (全螢幕展開) */
    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); border-top: 1px solid #dee2e6; border-left: 1px solid #dee2e6; }
    .detail-cell { display: flex; border-bottom: 1px solid #dee2e6; border-right: 1px solid #dee2e6; min-height: 40px; }
    .detail-label { width: 140px; background-color: #f8f9fa; border-right: 1px solid #dee2e6; padding: 10px; font-size: 12px; font-weight: 700; color: #666; flex-shrink: 0; display: flex; align-items: center; }
    .detail-value { flex-grow: 1; display: flex; align-items: center; }
    .detail-input { width: 100%; height: 100%; padding: 0 12px; border: none; font-size: 14px; outline: none; }
    .detail-input:focus { background-color: #fffde7; }
    .detail-input:disabled { background-color: #f1f3f5; color: #999; cursor: not-allowed; }

    /* 滾動條優化 */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; }
    ::-webkit-scrollbar-thumb:hover { background: #bbb; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    /**
     * 規格鎖定：環境變數管理
     * 優先讀取全域配置(Cloudflare 注入用)，其次為手動設定
     */
    const CONFIG = {
      GAS_URL: window.CRM_CONFIG?.GAS_URL || "https://script.google.com/macros/s/您的ID/exec",
      VERSION: "1.2.0"
    };

    const Icon = ({ name, size = 18, className = "" }) => {
      const paths = {
        dashboard: "M3 3h7v7H3V3zm11 0h7v7h-7V3zm0 11h7v7h-7v-7zm-11 0h7v7H3v-7z",
        calendar: "M8 7V3m8 4V3M3 11h18M5 5h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z",
        users: "M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2m12-17a4 4 0 11-8 0 4 4 0 018 0zm6 17v-2a4 4 0 00-3-3.87m-4-12a4 4 0 010 7.75",
        search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
        menu: "M3 12h18M3 6h18M3 18h18",
        logout: "M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4m7 14l5-5-5-5m5 5H9",
        building: "M3 21h18M3 7v14m18-14v14M3 7l9-4 9 4M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6",
        userCircle: "M12 12a5 5 0 100-10 5 5 0 000 10zm-7 8a7 7 0 0114 0",
        save: "M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z",
        plus: "M12 5v14M5 12h14",
        chevronLeft: "M15 18l-6-6 6-6"
      };
      return (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d={paths[name] || ""} />
        </svg>
      );
    };

    const callApi = async (action, params = {}) => {
      try {
        const queryParams = new URLSearchParams({ action, ...params }).toString();
        // 如果網址尚未配置且在預覽環境，則回傳模擬資料
        if (CONFIG.GAS_URL.includes("您的ID")) return getMockData(action, params.type);
        
        const response = await fetch(`${CONFIG.GAS_URL}?${queryParams}`);
        return await response.json();
      } catch (error) {
        console.error("API Error:", error);
        return { success: false, error: "API 連線失敗" };
      }
    };

    const getMockData = (action, type) => {
      if (action === 'getDashboard') return { success: true, counts: { association: 120, vendor: 45, general: 980, activities: 12 } };
      if (action === 'getMembers') {
        let cols = type === 'vendor' ? ['序號', '會員編號', '廠商會員公司名稱', '公司統編', '公司負責人姓名', '聯絡窗口姓名', '會員資格(Y/N)', '活動報名次數', '講座報名次數', '教學報名次數', '聯誼報名次數', '會議報名次數', '備註', 'userid', '是否綁定', '行動電話'] :
                   type === 'association' ? ['序號', '會員編號', '身分', '姓名', '性別', '會員資格(Y/N)', '活動報名次數', '講座報名次數', '教學報名次數', '聯誼報名次數', '會議報名次數', '備註', 'userid', '是否綁定', '行動電話'] :
                   ['序號', '姓名', 'MAIL', '性別', '會員資格(Y/N)', '活動報名次數', '講座報名次數', '教學報名次數', '聯誼報名次數', '會議報名次數', '備註', 'userid', '是否綁定', '行動電話'];
        let data = [];
        for (let i = 1; i <= 10; i++) {
          let obj = {};
          cols.forEach(c => obj[c] = c === 'MAIL' ? `user${i}@example.com` : (c.includes('次數') ? '0' : `範例-${c}-${i}`));
          obj['序號'] = i;
          data.push(obj);
        }
        return { success: true, data };
      }
      return { success: true, data: [] };
    };

    const App = () => {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [isSidebarOpen, setSidebarOpen] = useState(true);
      const [loading, setLoading] = useState(false);
      const [stats, setStats] = useState({ association: 0, vendor: 0, general: 0, activities: 0 });
      const [data, setData] = useState([]);
      const [memberType, setMemberType] = useState('general');
      const [editingItem, setEditingItem] = useState(null);

      useEffect(() => {
        if (activeTab === 'dashboard') loadStats();
      }, [activeTab]);

      const loadStats = async () => {
        setLoading(true);
        const res = await callApi('getDashboard');
        if (res.success) setStats(res.counts);
        setLoading(false);
      };

      const loadList = async (type) => {
        setLoading(true);
        setEditingItem(null); 
        setActiveTab(`members-${type}`);
        setMemberType(type);
        const res = await callApi('getMembers', { type });
        if (res.success) setData(res.data);
        setLoading(false);
      };

      const saveItem = async () => {
        setLoading(true);
        const res = await callApi('updateData', { type: memberType, data: JSON.stringify(editingItem) });
        if (res.success) {
          setData(prev => prev.map(item => item.序號 === editingItem.序號 ? editingItem : item));
          setEditingItem(null);
        }
        setLoading(false);
      };

      return (
        <div className="flex h-screen overflow-hidden bg-white text-sm">
          {/* Sidebar */}
          <aside className={`${isSidebarOpen ? 'w-52' : 'w-0'} sidebar-bg transition-all duration-200 flex flex-col shrink-0 z-20`}>
            <div className="h-12 flex items-center px-4 border-b border-white/10 shrink-0">
              <span className="text-white font-bold text-xs tracking-widest uppercase">CRM Admin</span>
            </div>
            <nav className="flex-1 mt-2 overflow-y-auto">
              <SidebarLink label="儀表板" icon="dashboard" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
              <SidebarLink label="協會會員清冊" icon="building" active={activeTab === 'members-association'} onClick={() => loadList('association')} />
              <SidebarLink label="廠商會員清冊" icon="users" active={activeTab === 'members-vendor'} onClick={() => loadList('vendor')} />
              <SidebarLink label="一般會員清冊" icon="userCircle" active={activeTab === 'members-general'} onClick={() => loadList('general')} />
            </nav>
            <div className="p-4 border-t border-white/10 text-[10px] text-gray-500">
              System v{CONFIG.VERSION}
            </div>
          </aside>

          {/* Main Content Area */}
          <main className="flex-1 flex flex-col overflow-hidden relative">
            <header className="h-12 bg-white border-b flex items-center justify-between px-4 shrink-0 z-10">
              <div className="flex items-center space-x-4">
                <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="p-1 hover:bg-gray-100 border">
                  <Icon name="menu" size={16} />
                </button>
                <div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                  {editingItem ? 'Detailed Editor' : activeTab.toUpperCase()}
                </div>
              </div>
            </header>

            <div className="flex-1 overflow-auto">
              {loading ? (
                <div className="flex items-center justify-center h-full text-xs font-bold text-gray-300 tracking-widest animate-pulse">SYNCHRONIZING...</div>
              ) : editingItem ? (
                /* --- Ragic 式詳情展開頁面 --- */
                <div className="h-full flex flex-col bg-[#f1f3f5]">
                  <div className="p-4 bg-white border-b flex justify-between items-center sticky top-0 z-20 shadow-sm">
                    <div className="flex items-center space-x-4">
                      <button onClick={() => setEditingItem(null)} className="p-1.5 border border-gray-300 bg-white hover:bg-gray-50 flex items-center space-x-2 transition-colors">
                        <Icon name="chevronLeft" size={14} />
                        <span className="text-xs font-bold">返回清單</span>
                      </button>
                      <h3 className="font-bold text-sm text-gray-700">詳細資料卡: <span className="text-blue-600">#{editingItem.序號}</span></h3>
                    </div>
                    <button onClick={saveItem} className="line-green text-white px-10 py-2 text-xs font-bold flex items-center space-x-2 active:scale-95 transition-all">
                      <Icon name="save" size={14} />
                      <span>儲存變更</span>
                    </button>
                  </div>
                  
                  <div className="flex-1 p-8 overflow-auto">
                    <div className="max-w-6xl mx-auto bg-white border border-gray-300 shadow-sm">
                      <div className="bg-[#f8f9fa] border-b border-gray-300 p-4">
                        <span className="text-[11px] font-black text-gray-400 uppercase tracking-widest">Database Record Detail View</span>
                      </div>
                      <div className="detail-grid">
                        {Object.keys(editingItem).map(key => (
                          <div key={key} className="detail-cell">
                            <div className="detail-label">{key}</div>
                            <div className="detail-value">
                              <input 
                                className="detail-input"
                                value={editingItem[key] || ''}
                                onChange={e => setEditingItem({...editingItem, [key]: e.target.value})}
                                /* 規格鎖定：唯讀保護 */
                                disabled={key === '序號' || key === '會員編號' || key === 'userid'}
                              />
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                    <p className="max-w-6xl mx-auto mt-4 text-[10px] text-gray-400 italic px-2">
                      * 灰色背景欄位受系統保護，無法直接修改。所有變更將直接同步至 Google Sheets。
                    </p>
                  </div>
                </div>
              ) : activeTab === 'dashboard' ? (
                /* --- 儀表板 --- */
                <div className="grid grid-cols-1 md:grid-cols-4 border-b">
                  <DashBox title="協會會員" count={stats.association} color="border-blue-500" />
                  <DashBox title="廠商會員" count={stats.vendor} color="border-orange-500" />
                  <DashBox title="一般會員" count={stats.general} color="border-green-500" />
                  <DashBox title="活動總數" count={stats.activities} color="border-purple-500" />
                </div>
              ) : (
                /* --- 資料表格清單 (已隱藏 MAIL 呈現) --- */
                <div className="h-full flex flex-col">
                  <div className="bg-gray-50 border-b p-2 flex justify-between items-center shrink-0">
                    <span className="text-[10px] font-bold text-gray-400 px-2 tracking-widest">RECORD COUNT: {data.length}</span>
                    <button className="line-green text-white px-4 py-1.5 text-xs font-bold flex items-center space-x-2 transition-transform active:scale-95">
                      <Icon name="plus" size={14} />
                      <span>新增一筆資料</span>
                    </button>
                  </div>
                  <div className="overflow-auto flex-1">
                    <table className="crm-table">
                      <thead className="sticky top-0 z-10">
                        <tr>
                          {data.length > 0 && Object.keys(data[0])
                            .filter(k => k !== 'MAIL') // 規格：前台清單不呈現 MAIL
                            .slice(0, 10)
                            .map(k => <th key={k}>{k}</th>)
                          }
                          <th className="text-center sticky right-0 bg-[#f1f3f5] border-l">管理選項</th>
                        </tr>
                      </thead>
                      <tbody>
                        {data.map((row, idx) => (
                          <tr key={idx}>
                            {Object.keys(row)
                              .filter(k => k !== 'MAIL') // 規格：前台清單不呈現 MAIL
                              .slice(0, 10)
                              .map((key, i) => <td key={i}>{String(row[key])}</td>)
                            }
                            <td className="text-center sticky right-0 bg-white border-l shadow-[-4px_0_8px_rgba(0,0,0,0.02)]">
                              <button 
                                onClick={() => setEditingItem(row)} 
                                className="text-blue-600 font-bold hover:underline px-3 py-1 text-xs"
                              >
                                編輯詳細
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          </main>
        </div>
      );
    };

    const SidebarLink = ({ label, icon, active, onClick }) => (
      <button onClick={onClick} className={`w-full flex items-center space-x-3 px-4 py-4 transition-all border-l-4 ${active ? 'sidebar-active border-white/20' : 'text-gray-500 hover:bg-[#2a2a2a] border-transparent'}`}>
        <Icon name={icon} size={16} />
        <span className="text-xs font-bold tracking-tight">{label}</span>
      </button>
    );

    const DashBox = ({ title, count, color }) => (
      <div className={`p-10 border-r last:border-r-0 border-b-8 ${color} hover:bg-gray-50 transition-colors cursor-default`}>
        <div className="text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2">{title}</div>
        <div className="text-4xl font-black text-gray-800 tracking-tighter">{count.toLocaleString()}</div>
      </div>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
