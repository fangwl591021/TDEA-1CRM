<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TDEA CRM - Stable Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #F4F5F7; margin: 0; color: #333; }
    * { border-radius: 0 !important; }

    .line-green { color: #06C755; }
    .line-green-bg { background-color: #06C755; }
    .sidebar-light { background-color: #F8F9FA; border-right: 1px solid #E5E7EB; }
    .sidebar-active { background-color: #FFFFFF; color: #06C755 !important; border-left: 4px solid #06C755; font-weight: 700; }
    
    .crm-table { width: 100%; border-collapse: collapse; background: white; }
    .crm-table th { background-color: #F9FAFB; border-bottom: 2px solid #E5E7EB; padding: 12px 15px; font-size: 13px; color: #6B7280; text-align: left; position: sticky; top: 0; z-index: 10; }
    .crm-table td { border-bottom: 1px solid #F3F4F6; padding: 10px 15px; font-size: 13px; white-space: nowrap; }
    
    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); border: 1px solid #E5E7EB; }
    .detail-label { width: 150px; background-color: #F9FAFB; border-right: 1px solid #E5E7EB; padding: 12px; font-size: 12px; font-weight: 700; color: #4B5563; }
    .detail-input { width: 100%; padding: 8px 12px; font-size: 14px; border: none; outline: none; background: white; }
    .detail-input:focus { background-color: #F0FDF4; }

    .collapsible-stats { transition: max-height 0.3s ease-in-out, opacity 0.2s; overflow: hidden; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #D1D5DB; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // 優先讀取 Cloudflare 注入，若無則讀取 LocalStorage
    const getInitialConfig = () => {
      if (window.CRM_CONFIG && window.CRM_CONFIG.GAS_URL) {
        return window.CRM_CONFIG.GAS_URL;
      }
      return localStorage.getItem('TDEA_GAS_URL') || "";
    };

    const Icon = ({ name, size = 18, className = "" }) => {
      const paths = {
        home: "M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6",
        users: "M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z",
        calendar: "M8 7V3m8 4V3M3 11h18M5 5h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z",
        chevronLeft: "M15 19l-7-7 7-7",
        chevronRight: "M9 5l7 7-7 7",
        chevronUp: "M18 15l-6-6-6 6",
        chevronDown: "M6 9l6 6 6-6",
        save: "M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z",
        plus: "M12 4v16m8-8H4",
        search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
        settings: "M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z"
      };
      return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={paths[name] || ""} /></svg>;
    };

    const App = () => {
      const [gasUrl, setGasUrl] = useState(getInitialConfig());
      const [showConfig, setShowConfig] = useState(!getInitialConfig());
      const [tempUrl, setTempUrl] = useState("");
      
      const [activeTab, setActiveTab] = useState('dashboard');
      const [collapsed, setCollapsed] = useState(false);
      const [dashExpanded, setDashExpanded] = useState(true);
      const [stats, setStats] = useState({ association: 0, vendor: 0, general: 0, activities: 0 });
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(false);
      
      const [editingItem, setEditingItem] = useState(null);
      const [isNewItem, setIsNewItem] = useState(false);
      const [isSaving, setIsSaving] = useState(false);

      const [status, setStatus] = useState("Checking...");
      const [errorDetails, setErrorDetails] = useState("");

      const saveConfig = () => {
        if (!tempUrl.trim()) return alert("請輸入 GAS 網址");
        localStorage.setItem('TDEA_GAS_URL', tempUrl.trim());
        setGasUrl(tempUrl.trim());
        setShowConfig(false);
        window.location.reload();
      };

      // --- 核心修正：穩健的錯誤捕捉 ---
      const callApi = async (action, params = {}, method = 'GET') => {
        setErrorDetails("");
        if (!gasUrl) {
          setStatus("MISSING CONFIG");
          return null;
        }

        try {
          // 判斷是否為 Worker 代理環境
          const config = window.CRM_CONFIG || {};
          // 如果有 PROXY_READY 標記，代表 Worker 正常運作，使用 /api
          // 否則使用 gasUrl 直接連線 (本地測試)
          const baseUrl = config.PROXY_READY ? "/api" : gasUrl;

          let res;
          if (method === 'GET') {
            const query = new URLSearchParams({ action, ...params }).toString();
            res = await fetch(`${baseUrl}?${query}`);
          } else {
            res = await fetch(baseUrl, {
              method: 'POST',
              body: JSON.stringify({ action, ...params })
            });
          }
          
          if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
          
          // 先取文字，再試圖解析，以便捕捉 HTML 錯誤頁面
          const text = await res.text();
          try {
            const json = JSON.parse(text);
            
            if (!json.success) {
               throw new Error(json.error || "GAS 內部錯誤");
            }

            setStatus("CONNECTED");
            return json;

          } catch (jsonErr) {
            console.error("非 JSON 回應:", text.substring(0, 200));
            if (text.includes("<!DOCTYPE html>") || text.includes("Google Accounts")) {
               throw new Error("權限錯誤：GAS 回傳了登入頁面 (HTML)。\n請至 Google Apps Script > 部署 > 管理部署 > 編輯，確認「誰有權存取」已設為「所有人 (Anyone)」。");
            }
            throw new Error("資料格式錯誤 (Invalid JSON)");
          }

        } catch (e) {
          console.error("Fetch Failed:", e);
          setStatus("CONNECTION FAILED");
          setErrorDetails(e.message);
          return null;
        }
      };

      useEffect(() => {
        if (activeTab === 'dashboard' && gasUrl) {
          setLoading(true);
          callApi('getDashboard').then(res => {
            if (res && res.success) setStats(res.counts);
            setLoading(false);
          });
        }
      }, [activeTab, gasUrl]);

      const loadList = async (type) => {
        if(!gasUrl) { setShowConfig(true); return; }
        setLoading(true); setEditingItem(null); setActiveTab(type); setErrorDetails("");
        const res = await callApi('getMembers', { type });
        if (res && res.success) setData(res.data);
        else setData([]);
        setLoading(false);
      };

      const handleAdd = () => {
        if (data.length === 0) {
            alert("目前清單為空，無法複製欄位結構，請先確認 Google 試算表有標題列。");
            return;
        }
        const template = { ...data[0] };
        Object.keys(template).forEach(k => template[k] = "");
        template['序號'] = "(系統自動產生)";
        setEditingItem(template);
        setIsNewItem(true);
      };

      const handleSave = async () => {
        setIsSaving(true);
        const action = isNewItem ? 'addData' : 'updateData';
        const res = await callApi(action, { 
          type: activeTab, 
          data: JSON.stringify(editingItem) 
        }, 'POST');

        if (res && res.success) {
          alert(isNewItem ? "新增成功！" : "更新成功！");
          setEditingItem(null);
          loadList(activeTab); 
        } else {
          alert("儲存失敗：" + (res?.error || "請檢查權限"));
        }
        setIsSaving(false);
      };

      return (
        <div className="flex h-screen overflow-hidden">
          {showConfig && (
            <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center">
              <div className="bg-white p-8 w-96 shadow-2xl">
                <h2 className="text-lg font-bold mb-4">系統設定</h2>
                <input value={tempUrl} onChange={e => setTempUrl(e.target.value)} placeholder="GAS URL..." className="w-full border p-2 mb-4 text-xs"/>
                <button onClick={saveConfig} className="w-full line-green-bg text-white py-2 font-bold text-sm">儲存</button>
              </div>
            </div>
          )}

          <aside className={`sidebar-light flex flex-col shrink-0 z-20 transition-all duration-300 ${collapsed ? 'w-16' : 'w-60'}`}>
            <div className="h-16 flex items-center px-4 border-b border-gray-200">
              <div className="w-8 h-8 line-green-bg flex items-center justify-center shrink-0"><span className="text-white text-[10px] font-black">OA</span></div>
              {!collapsed && <span className="ml-3 font-bold text-gray-700 text-sm">TDEA 管理中心</span>}
            </div>
            <nav className="flex-1 py-4 overflow-y-auto">
              <SidebarLink icon="home" label="主頁概覽" active={activeTab === 'dashboard'} collapsed={collapsed} onClick={() => setActiveTab('dashboard')} />
              {!collapsed && <div className="px-6 py-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest">資料模組</div>}
              <SidebarLink icon="users" label="本業會員" active={activeTab === 'association'} collapsed={collapsed} onClick={() => loadList('association')} />
              <SidebarLink icon="users" label="廠商會員" active={activeTab === 'vendor'} collapsed={collapsed} onClick={() => loadList('vendor')} />
              <SidebarLink icon="users" label="一般會員" active={activeTab === 'general'} collapsed={collapsed} onClick={() => loadList('general')} />
              <SidebarLink icon="calendar" label="活動 LIST" active={activeTab === 'activities'} collapsed={collapsed} onClick={() => loadList('activities')} />
            </nav>
            <button onClick={() => setCollapsed(!collapsed)} className="h-12 border-t border-gray-200 flex items-center px-6 text-gray-400 hover:text-green-500">
               <Icon name={collapsed ? "chevronRight" : "chevronLeft"} size={16} />
               {!collapsed && <span className="ml-3 text-[10px] font-bold">收合選單</span>}
            </button>
          </aside>

          <main className="flex-1 flex flex-col overflow-hidden">
            <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0">
              <span className="text-sm font-bold text-[#06C755] uppercase tracking-wide">{activeTab}</span>
              <div className="flex items-center space-x-2">
                <button onClick={() => setShowConfig(true)} className="p-1 text-gray-400 hover:text-gray-600"><Icon name="settings" size={14}/></button>
                <div className={`px-2 py-0.5 text-[10px] font-bold border ${status === 'CONNECTED' ? 'line-green-bg text-white' : 'text-red-400 border-red-300'}`}>{status}</div>
              </div>
            </header>
            
            <div className="flex-1 overflow-auto p-8">
               {errorDetails && <div className="bg-red-50 text-red-600 p-4 mb-4 border border-red-200 text-xs font-bold whitespace-pre-wrap">{errorDetails}</div>}
               
               {loading ? <div className="text-center p-20 text-gray-300 font-bold animate-pulse text-xs uppercase">Loading...</div> :
                editingItem ? (
                  <div className="flex flex-col h-full animate-in fade-in duration-300">
                    <div className="mb-6 flex justify-between items-center">
                      <button onClick={() => setEditingItem(null)} className="px-4 py-2 bg-white border border-gray-300 text-xs font-bold hover:bg-gray-50 flex items-center"><Icon name="chevronLeft" size={14} className="mr-2" />返回名冊</button>
                      <div className="flex items-center space-x-2">
                        <span className="text-xs font-bold text-gray-400 mr-2">{isNewItem ? "建立新資料" : "編輯資料"}</span>
                        <button onClick={handleSave} disabled={isSaving} className="line-green-bg text-white px-8 py-2 text-xs font-bold shadow-sm flex items-center disabled:opacity-50">
                          <Icon name="save" size={14} className="mr-2" />{isSaving ? "儲存中..." : "儲存變更"}
                        </button>
                      </div>
                    </div>
                    <div className="bg-white border border-gray-200 shadow-sm"><div className="detail-grid">{Object.keys(editingItem).map(k => (
                      <div key={k} className="detail-cell"><div className="detail-label">{k}</div><div className="flex-1"><input className="detail-input" value={editingItem[k]||''} onChange={e=>setEditingItem({...editingItem,[k]:e.target.value})} disabled={!isNewItem && (k.includes('序號')||k.includes('編號')||k==='userid')} /></div></div>
                    ))}</div></div>
                  </div>
                ) : activeTab === 'dashboard' ? (
                  <div className="flex flex-col space-y-8">
                    <div className="flex items-center justify-between">
                      <h2 className="text-2xl font-bold text-gray-800 tracking-tight">數據概覽</h2>
                      <button onClick={() => setDashExpanded(!dashExpanded)} className="px-3 py-1.5 bg-white border border-gray-300 text-[11px] font-bold text-gray-500 flex items-center hover:line-green-text">{dashExpanded ? "收合" : "展開"}<Icon name={dashExpanded ? "chevronUp" : "chevronDown"} size={14} className="ml-2" /></button>
                    </div>
                    <div className={`grid grid-cols-1 md:grid-cols-4 gap-6 collapsible-stats ${dashExpanded ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'}`}>
                      <StatCard title="本業會員" value={stats.association} label="Active" />
                      <StatCard title="廠商會員" value={stats.vendor} label="Partners" />
                      <StatCard title="一般會員" value={stats.general} label="Followers" />
                      <StatCard title="活動總計" value={stats.activities} label="Events" />
                    </div>
                  </div>
                ) : (
                  <div className="bg-white border border-gray-200 shadow-sm flex flex-col h-full overflow-hidden">
                    <div className="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50/30">
                      <span className="text-[11px] font-black text-gray-400 uppercase tracking-widest">Total: {data.length} Records</span>
                      <button onClick={handleAdd} className="line-green-bg text-white px-5 py-1.5 text-xs font-bold active:scale-95 shadow-sm flex items-center"><Icon name="plus" size={14} className="mr-1"/>新增</button>
                    </div>
                    <div className="overflow-auto flex-1">
                      <table className="crm-table">
                        <thead><tr>{data.length > 0 && Object.keys(data[0]).filter(k => k !== 'MAIL').slice(0, 10).map(k => <th key={k}>{k}</th>)}<th className="text-center sticky right-0 bg-gray-50 border-l border-gray-200">管理</th></tr></thead>
                        <tbody>{data.map((r, i) => (<tr key={i}>{Object.keys(r).filter(k => k !== 'MAIL').slice(0, 10).map((k, j) => <td key={j}>{String(r[k])}</td>)}<td className="text-center sticky right-0 bg-white border-l border-gray-200"><button onClick={() => { setEditingItem(r); setIsNewItem(false); }} className="text-[#06C755] font-bold text-xs hover:underline px-4 py-2 transition-colors">編輯詳細</button></td></tr>))}</tbody>
                      </table>
                    </div>
                  </div>
                )}
            </div>
          </main>
        </div>
      );
    };

    const SidebarLink = ({ icon, label, active, collapsed, onClick }) => (<button onClick={onClick} className={`w-full flex items-center py-4 transition-all ${active ? 'sidebar-active shadow-sm' : 'text-gray-500 hover:bg-[#EDF2F7]'} ${collapsed ? 'justify-center' : 'px-6'}`}><Icon name={icon} size={20} className={collapsed ? '' : 'mr-3'} />{!collapsed && <span className="text-sm font-medium tracking-tight">{label}</span>}</button>);
    const StatCard = ({ title, value, label }) => (<div className="bg-white border border-gray-200 p-6 border-l-4 border-l-[#06C755] shadow-sm"><div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">{title}</div><div className="text-3xl font-black text-gray-800 tracking-tighter">{value.toLocaleString()}</div></div>);
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
