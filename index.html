<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Enterprise Management System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;700&display=swap');
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #ffffff; color: #333; margin: 0; }
    
    /* 規格鎖定：Ragic 式硬邊框，全域無圓角 */
    * { border-radius: 0 !important; }

    .line-green { background-color: #06C755; }
    .sidebar-bg { background-color: #1a1a1a; }
    .sidebar-item:hover { background-color: #2a2a2a; }
    .sidebar-active { background-color: #06C755 !important; color: #fff !important; }
    
    .crm-table { width: 100%; border-collapse: collapse; }
    .crm-table th { background-color: #f1f3f5; border: 1px solid #dee2e6; padding: 10px 12px; font-size: 13px; font-weight: 700; color: #495057; text-align: left; position: sticky; top: 0; z-index: 10; }
    .crm-table td { border: 1px solid #dee2e6; padding: 8px 12px; font-size: 13px; white-space: nowrap; }
    .crm-table tr:hover { background-color: #f8f9fa; }

    /* RAGIC 詳細資料格線佈局 */
    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); border-top: 1px solid #dee2e6; border-left: 1px solid #dee2e6; }
    .detail-cell { display: flex; border-bottom: 1px solid #dee2e6; border-right: 1px solid #dee2e6; min-height: 44px; }
    .detail-label { width: 160px; background-color: #f8f9fa; border-right: 1px solid #dee2e6; padding: 10px 15px; font-size: 11px; font-weight: 700; color: #666; flex-shrink: 0; display: flex; align-items: center; }
    .detail-value { flex-grow: 1; display: flex; align-items: center; }
    .detail-input { width: 100%; height: 100%; padding: 0 15px; border: none; font-size: 14px; outline: none; }
    .detail-input:focus { background-color: #fffde7; }
    .detail-input:disabled { background-color: #f1f3f5; color: #999; cursor: not-allowed; }

    /* 收合動畫效果 */
    .collapse-transition { transition: all 0.2s ease-in-out; overflow: hidden; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // 優先讀取 Cloudflare 注入變數
    const CONFIG = { GAS_URL: window.CRM_CONFIG?.GAS_URL || "" };

    const Icon = ({ name, size = 18, className = "" }) => {
      const paths = {
        dashboard: "M3 3h7v7H3V3zm11 0h7v7h-7V3zm0 11h7v7h-7v-7zm-11 0h7v7H3v-7z",
        calendar: "M8 7V3m8 4V3M3 11h18M5 5h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z",
        users: "M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2m12-17a4 4 0 11-8 0 4 4 0 018 0zm6 17v-2a4 4 0 00-3-3.87m-4-12a4 4 0 010 7.75",
        menu: "M3 12h18M3 6h18M3 18h18",
        save: "M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z",
        back: "M15 18l-6-6 6-6",
        building: "M3 21h18M3 7v14m18-14v14M3 7l9-4 9 4M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6",
        chevronDown: "M6 9l6 6 6-6",
        chevronUp: "M18 15l-6-6-6 6"
      };
      return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={paths[name] || ""} /></svg>;
    };

    const App = () => {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [isSidebarOpen, setSidebarOpen] = useState(true);
      const [isDashExpanded, setDashExpanded] = useState(true);
      const [loading, setLoading] = useState(false);
      const [stats, setStats] = useState({ association: 0, vendor: 0, general: 0, activities: 0 });
      const [data, setData] = useState([]);
      const [editingItem, setEditingItem] = useState(null);

      // 模擬資料生成邏輯
      const getMockData = (action, type) => {
        if (action === 'getDashboard') return { success: true, counts: { association: 128, vendor: 42, general: 1056, activities: 15 } };
        if (action === 'getMembers') {
          const mockList = [];
          for (let i = 1; i <= 20; i++) {
            const base = { '序號': i, '會員資格(Y/N)': 'Y', '活動報名次數': '2', '講座報名次數': '0', '教學報名次數': '1', 'userid': `U100${i}`, '是否綁定': 'Y', '行動電話': '0912-345-678' };
            if (type === 'association') mockList.push({ '會員編號': `A00${i}`, '身分': '理事', '姓名': `協會成員 ${i}`, '性別': '男', ...base });
            else if (type === 'vendor') mockList.push({ '會員編號': `V00${i}`, '廠商會員公司名稱': `科技公司 ${i}`, '公司統編': '12345678', '公司負責人姓名': '負責人', '聯絡窗口姓名': '窗口', ...base });
            else mockList.push({ '姓名': `一般會員 ${i}`, 'MAIL': `user${i}@mail.com`, '性別': '女', ...base });
          }
          return { success: true, data: mockList };
        }
        return { success: true };
      };

      const callApi = async (action, params = {}) => {
        // 如果沒有 GAS_URL，直接回傳模擬資料
        if (!CONFIG.GAS_URL || CONFIG.GAS_URL === "") {
          return getMockData(action, params.type);
        }
        try {
          const query = new URLSearchParams({ action, ...params }).toString();
          const res = await fetch(`${CONFIG.GAS_URL}?${query}`);
          return await res.json();
        } catch (e) {
          console.error("API Error, falling back to mock data", e);
          return getMockData(action, params.type);
        }
      };

      const loadStats = async () => {
        setLoading(true);
        const res = await callApi('getDashboard');
        if (res.success) setStats(res.counts);
        setLoading(false);
      };

      const loadList = async (type) => {
        setLoading(true);
        setEditingItem(null);
        setActiveTab(type);
        const res = await callApi('getMembers', { type });
        if (res.success) setData(res.data);
        setLoading(false);
      };

      useEffect(() => {
        if (activeTab === 'dashboard') loadStats();
      }, [activeTab]);

      return (
        <div className="flex h-screen overflow-hidden bg-white text-sm">
          {/* Sidebar */}
          <aside className={`${isSidebarOpen ? 'w-52' : 'w-0'} sidebar-bg transition-all duration-200 flex flex-col shrink-0 z-20 overflow-hidden`}>
            <div className="h-12 flex items-center px-4 border-b border-white/10 shrink-0 min-w-[208px]">
              <span className="text-white font-bold text-xs tracking-widest uppercase">CRM Admin</span>
            </div>
            <nav className="flex-1 mt-2 overflow-y-auto min-w-[208px]">
              <SidebarLink label="儀表板" icon="dashboard" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
              <div className="px-4 py-3 text-[10px] text-gray-500 font-bold uppercase tracking-widest border-t border-white/5 mt-2 text-white/40">會員清冊管理</div>
              <SidebarLink label="本業會員" icon="building" active={activeTab === 'association'} onClick={() => loadList('association')} />
              <SidebarLink label="廠商會員" icon="users" active={activeTab === 'vendor'} onClick={() => loadList('vendor')} />
              <SidebarLink label="一般會員" icon="users" active={activeTab === 'general'} onClick={() => loadList('general')} />
            </nav>
          </aside>

          {/* Main Area */}
          <main className="flex-1 flex flex-col overflow-hidden relative">
            <header className="h-12 border-b flex items-center justify-between px-4 shrink-0 bg-white z-10">
              <div className="flex items-center space-x-4">
                <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="p-1 border hover:bg-gray-100 transition-colors">
                  <Icon name="menu" size={16} />
                </button>
                <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{activeTab}</span>
              </div>
              <div className="flex items-center space-x-3">
                <div className={`text-[9px] font-bold uppercase tracking-tighter px-2 py-0.5 border ${CONFIG.GAS_URL ? 'text-[#06C755] border-[#06C755]' : 'text-gray-400 border-gray-300'}`}>
                  {CONFIG.GAS_URL ? "Database Live" : "Preview Mode"}
                </div>
              </div>
            </header>

            <div className="flex-1 overflow-auto bg-[#fafafa]">
              {loading ? (
                <div className="flex items-center justify-center h-full text-gray-300 font-bold tracking-widest animate-pulse italic">SYNCHRONIZING...</div>
              ) : editingItem ? (
                /* --- Ragic 式詳情展開頁面 --- */
                <div className="h-full flex flex-col bg-[#f1f3f5]">
                  <div className="p-4 bg-white border-b flex justify-between items-center sticky top-0 z-20 shadow-sm">
                    <div className="flex items-center space-x-4">
                      <button onClick={() => setEditingItem(null)} className="p-1.5 border border-gray-300 bg-white hover:bg-gray-50 flex items-center space-x-2 text-xs font-bold transition-all">
                        <Icon name="back" size={14} />
                        <span>返回清單</span>
                      </button>
                      <h3 className="font-bold text-sm text-gray-700">詳細資料卡: <span className="text-[#06C755]">#{editingItem.序號}</span></h3>
                    </div>
                    <button onClick={async () => {
                      setLoading(true);
                      const res = await callApi('updateData', { type: activeTab, data: JSON.stringify(editingItem) });
                      if(res.success) setEditingItem(null);
                      setLoading(false);
                    }} className="bg-[#06C755] text-white px-10 py-2 text-xs font-bold flex items-center space-x-2 active:scale-95 transition-all shadow-md">
                      <Icon name="save" size={14} />
                      <span>儲存更新</span>
                    </button>
                  </div>
                  <div className="flex-1 p-8 overflow-auto">
                    <div className="max-w-6xl mx-auto bg-white border border-gray-300 shadow-sm">
                      <div className="detail-grid">
                        {Object.keys(editingItem).map(k => (
                          <div key={k} className="detail-cell">
                            <div className="detail-label">{k}</div>
                            <div className="detail-value">
                              <input 
                                className="detail-input" 
                                value={editingItem[k] || ''} 
                                onChange={e => setEditingItem({...editingItem, [k]: e.target.value})} 
                                disabled={k.includes('序號') || k.includes('編號') || k==='userid'} 
                              />
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
               ) : activeTab === 'dashboard' ? (
                /* --- 儀表板與收合功能 --- */
                <div className="flex flex-col h-full">
                  <div className="flex items-center justify-between px-4 py-2 bg-gray-50 border-b">
                    <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">系統數據概覽</span>
                    <button 
                      onClick={() => setDashExpanded(!isDashExpanded)}
                      className="text-gray-400 hover:text-[#06C755] transition-colors flex items-center space-x-1"
                    >
                      <span className="text-[10px] font-bold">{isDashExpanded ? "收合" : "展開"}</span>
                      <Icon name={isDashExpanded ? "chevronUp" : "chevronDown"} size={14} />
                    </button>
                  </div>
                  <div className={`grid grid-cols-1 md:grid-cols-4 border-b bg-white collapse-transition ${isDashExpanded ? 'max-h-[500px]' : 'max-h-0 border-none'}`}>
                    <DashBox title="本業會員" count={stats.association} color="border-[#06C755]" />
                    <DashBox title="廠商會員" count={stats.vendor} color="border-[#05A647]" />
                    <DashBox title="一般會員" count={stats.general} color="border-[#048739]" />
                    <DashBox title="活動總計" count={stats.activities} color="border-[#03692C]" />
                  </div>
                  <div className="flex-1 flex flex-col items-center justify-center p-10 opacity-10">
                     <Icon name="dashboard" size={120} />
                     <h2 className="text-3xl font-black tracking-[1em] mt-4 uppercase">Management</h2>
                  </div>
                </div>
               ) : (
                /* --- 資料表格清單 --- */
                <div className="h-full flex flex-col">
                  <div className="overflow-auto flex-1 bg-white">
                    <table className="crm-table">
                      <thead className="sticky top-0 z-10 shadow-sm">
                        <tr>
                          {data.length > 0 && Object.keys(data[0])
                            .filter(k => k !== 'MAIL')
                            .slice(0, 10)
                            .map(k => <th key={k}>{k}</th>)
                          }
                          <th className="text-center sticky right-0 bg-[#f1f3f5] border-l">管理項目</th>
                        </tr>
                      </thead>
                      <tbody>
                        {data.map((r, i) => (
                          <tr key={i}>
                            {Object.keys(r)
                              .filter(k => k !== 'MAIL')
                              .slice(0, 10)
                              .map((k, j) => <td key={j}>{String(r[k])}</td>)
                            }
                            <td className="text-center sticky right-0 bg-white border-l shadow-[-4px_0_12px_rgba(0,0,0,0.03)]">
                              <button onClick={() => setEditingItem(r)} className="text-blue-600 font-bold text-xs hover:underline px-4 py-2 transition-all hover:bg-blue-50">編輯詳細</button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
               )}
            </div>
          </main>
        </div>
      );
    };

    const SidebarLink = ({ label, icon, active, onClick }) => (
      <button onClick={onClick} className={`w-full flex items-center space-x-3 px-4 py-4 transition-all border-l-4 ${active ? 'sidebar-active border-white/20' : 'text-gray-400 border-transparent'}`}>
        <Icon name={icon} size={16} />
        <span className="text-xs font-bold tracking-tight">{label}</span>
      </button>
    );

    const DashBox = ({ title, count, color }) => (
      <div className={`p-10 border-r last:border-r-0 border-b-8 ${color} hover:bg-[#f0fdf4] transition-all cursor-default`}>
        <div className="text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2">{title}</div>
        <div className="text-4xl font-black text-gray-800 tracking-tighter">{count.toLocaleString()}</div>
      </div>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
