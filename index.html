<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Island | 管理後台 V3.9</title>
    <!-- 使用標準字體大小，對齊 LINE OA 規格 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { 
            --line-green: #06C755; 
            --line-dark: #0f172a; 
            --line-bg: #f4f6f9;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: var(--line-bg);
            font-size: 16px; 
        }
        .nav-active { background-color: #1e293b; color: var(--line-green); border-left: 5px solid var(--line-green); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* 側邊欄過渡 */
        aside { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-text { transition: opacity 0.2s, visibility 0.2s; white-space: nowrap; }
        .collapsed .sidebar-text { opacity: 0; visibility: hidden; width: 0; pointer-events: none; }
        .collapsed .nav-item { justify-content: center; padding-left: 0; padding-right: 0; }
        .collapsed .sidebar-header-box { justify-content: center; padding: 1.5rem 0; }
        
        input:focus, select:focus, textarea:focus { 
            border-color: var(--line-green) !important; 
            box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.1);
            outline: none; 
        }
        
        .img-preview { width: 100%; height: 160px; object-fit: cover; border-radius: 12px; background-color: #e2e8f0; display: flex; align-items: center; justify-content: center; }
        .edit-mode { border: 2px solid #fbbf24; background-color: #fffbeb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .btn-active:active { transform: scale(0.98); opacity: 0.9; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--line-green); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800 font-sans">

    <!-- Sidebar Navigation (Sports Island) -->
    <aside id="appSidebar" class="w-64 bg-[#0f172a] text-white flex flex-col h-full shadow-xl z-20 shrink-0 relative overflow-hidden">
        <div class="sidebar-header-box p-8 flex items-center gap-4 border-b border-slate-800 transition-all">
            <div class="w-12 h-12 bg-[#06C755] rounded-xl flex items-center justify-center font-bold text-white shadow-lg text-3xl shrink-0 font-sans">S</div>
            <span class="sidebar-text font-black text-2xl tracking-tighter uppercase italic">Sports Island</span>
        </div>

        <nav class="flex-1 mt-6 overflow-y-auto no-scrollbar">
            <a href="javascript:void(0)" onclick="switchTab('dashboard')" class="nav-item nav-active flex items-center gap-4 px-8 py-5 transition-all" data-tab="dashboard">
                <i data-lucide="layout-dashboard" class="w-6 h-6 shrink-0"></i>
                <span class="sidebar-text font-bold text-base">數據概覽</span>
            </a>
            <a href="javascript:void(0)" onclick="switchTab('members')" class="nav-item flex items-center gap-4 px-8 py-5 text-slate-400 hover:text-white transition-all" data-tab="members">
                <i data-lucide="users" class="w-6 h-6 shrink-0"></i>
                <span class="sidebar-text font-bold text-base">會員名冊</span>
            </a>
            <a href="javascript:void(0)" onclick="switchTab('courses')" class="nav-item flex items-center gap-4 px-8 py-5 text-slate-400 hover:text-white transition-all" data-tab="courses">
                <i data-lucide="calendar" class="w-6 h-6 shrink-0"></i>
                <span class="sidebar-text font-bold text-base">課程建置</span>
            </a>
            
            <div class="border-t border-slate-800 my-6 mx-6"></div>
            
            <a href="javascript:void(0)" onclick="switchTab('settings')" class="nav-item flex items-center gap-4 px-8 py-5 text-slate-400 hover:text-white transition-all" data-tab="settings">
                <i data-lucide="settings" class="w-6 h-6 shrink-0 text-slate-200"></i>
                <span class="sidebar-text font-bold text-base">系統設置</span>
            </a>
        </nav>
        
        <div id="sidebarFooter" class="p-6 border-t border-slate-800 text-xs text-slate-500 text-center font-black tracking-widest bg-slate-900/50">
            <span class="sidebar-text uppercase">V3.9 Admin</span>
            <span class="collapsed-ver hidden">V3.9</span>
        </div>
    </aside>

    <!-- Main Workspace -->
    <div class="flex-1 flex flex-col min-w-0 relative">
        <header class="h-24 bg-white shadow-sm flex items-center justify-between px-10 border-b">
            <div class="flex items-center gap-8">
                <!-- 收合按鈕 ICON -->
                <button onclick="toggleSidebar()" class="p-3 hover:bg-slate-100 rounded-xl text-slate-500 transition-colors btn-active">
                    <i data-lucide="menu" id="toggleIcon" class="w-8 h-8"></i>
                </button>
                <h2 id="tabTitle" class="text-3xl font-black text-slate-800 tracking-tight uppercase italic">數據概覽</h2>
                <div id="loadingIndicator" class="hidden flex items-center gap-3 text-base text-green-600 font-bold bg-green-50 px-4 py-2 rounded-full">
                    <div class="loader"></div> <span class="animate-pulse">同步中...</span>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div id="apiStatusDot" class="w-4 h-4 rounded-full bg-red-500 shadow-sm animate-pulse"></div>
                <div class="px-5 py-2 bg-slate-100 rounded-full border border-slate-200 hidden md:block">
                    <span class="text-sm font-black text-slate-600 uppercase tracking-widest">Admin: Tony</span>
                </div>
            </div>
        </header>

        <main id="scrollArea" class="flex-1 overflow-y-auto p-10 md:p-14">
            
            <!-- Tab: Dashboard -->
            <div id="tabDashboard" class="tab-content active space-y-10">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="bg-white p-10 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-8">
                        <div class="p-6 bg-green-50 text-green-500 rounded-2xl shadow-inner"><i data-lucide="users" class="w-10 h-10"></i></div>
                        <div>
                            <p class="text-sm text-slate-400 font-black uppercase tracking-widest mb-1">總會員人數</p>
                            <h3 id="statMembers" class="text-5xl font-black text-slate-800 tracking-tighter">--</h3>
                        </div>
                    </div>
                    <div class="bg-white p-10 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-8">
                        <div class="p-6 bg-blue-50 text-blue-500 rounded-2xl shadow-inner"><i data-lucide="calendar" class="w-10 h-10"></i></div>
                        <div>
                            <p class="text-sm text-slate-400 font-black uppercase tracking-widest mb-1">目前課程</p>
                            <h3 id="statCourses" class="text-5xl font-black text-slate-800 tracking-tighter">--</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Courses -->
            <div id="tabCourses" class="tab-content space-y-10">
                <div id="courseFormBlock" class="bg-white p-10 rounded-3xl shadow-sm border border-slate-200 transition-all">
                    <div class="flex items-center justify-between mb-10 border-b border-slate-100 pb-8">
                        <h3 id="formTitle" class="font-black text-3xl text-slate-800 flex items-center gap-4 italic uppercase">
                            <i data-lucide="plus-circle" class="w-10 h-10 text-green-500"></i> 課程活動建置
                        </h3>
                        <div id="editBadge" class="hidden text-sm bg-amber-100 text-amber-600 px-6 py-2 rounded-full font-black animate-pulse shadow-sm">
                            <i data-lucide="edit-3" class="w-4 h-4 inline mr-2"></i> 編輯模式啟動中
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-10">
                        <input type="hidden" id="fieldId">
                        
                        <div class="lg:col-span-2">
                            <label class="text-sm font-black text-slate-500 uppercase tracking-widest mb-3 block">課程名稱</label>
                            <input type="text" id="fieldName" placeholder="請輸入活動標題..." class="w-full p-5 bg-white border border-slate-300 rounded-2xl outline-none font-bold text-lg">
                        </div>
                        
                        <div>
                            <label class="text-sm font-black text-slate-500 uppercase tracking-widest mb-3 block">等級限制</label>
                            <select id="fieldLevelReq" class="w-full p-5 bg-white border border-slate-300 rounded-2xl outline-none text-lg font-bold">
                                <option value="初級">初級</option>
                                <option value="進階">進階</option>
                                <option value="高級">高級</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="text-sm font-black text-slate-500 uppercase tracking-widest mb-3 block">授課教練</label>
                            <input type="text" id="fieldCoach" placeholder="教練姓名" class="w-full p-5 bg-white border border-slate-300 rounded-2xl outline-none font-bold text-lg">
                        </div>
                        
                        <div class="lg:col-span-2">
                            <label class="text-sm font-black text-slate-500 uppercase tracking-widest mb-3 block text-blue-600">首頁封面圖網址</label>
                            <input type="text" id="fieldCoverUrl" oninput="previewImg('cover', this.value)" placeholder="https://..." class="w-full p-5 bg-slate-50 border border-slate-300 rounded-2xl outline-none font-mono text-sm">
                            <div id="preCover" class="img-preview mt-4 border-2 border-dashed border-slate-200"></div>
                        </div>
                        
                        <div class="lg:col-span-2">
                            <label class="text-sm font-black text-slate-500 uppercase tracking-widest mb-3 block text-blue-600">詳情說明圖網址</label>
                            <input type="text" id="fieldDescImgUrl" oninput="previewImg('desc', this.value)" placeholder="https://..." class="w-full p-5 bg-slate-50 border border-slate-300 rounded-2xl outline-none font-mono text-sm">
                            <div id="preDesc" class="img-preview mt-4 border-2 border-dashed border-slate-200"></div>
                        </div>

                        <div><label class="text-sm font-black text-slate-500 mb-3 block uppercase">日期</label><input type="date" id="fieldDate" class="w-full p-5 border rounded-2xl font-bold"></div>
                        <div><label class="text-sm font-black text-slate-500 mb-3 block uppercase">時段</label><input type="text" id="fieldTime" placeholder="14:00-16:00" class="w-full p-5 border rounded-2xl font-bold"></div>
                        <div><label class="text-sm font-black text-slate-500 mb-3 block uppercase">價格</label><input type="number" id="fieldPrice" class="w-full p-5 border rounded-2xl font-black"></div>
                        <div><label class="text-sm font-black text-red-500 mb-3 block uppercase">早鳥價</label><input type="number" id="fieldEarlyPrice" class="w-full p-5 border-2 border-red-100 bg-red-50/50 rounded-2xl text-red-600 font-black"></div>
                        
                        <div class="lg:col-span-2"><label class="text-sm font-black text-slate-500 mb-3 block uppercase">早鳥截止日</label><input type="datetime-local" id="fieldEarlyDeadline" class="w-full p-5 border rounded-2xl font-bold"></div>
                        <div><label class="text-sm font-black text-slate-500 mb-3 block uppercase">名額</label><input type="number" id="fieldSlots" class="w-full p-5 border rounded-2xl font-bold"></div>
                        <div><label class="text-sm font-black text-slate-500 mb-3 block uppercase">候補人數</label><input type="number" id="fieldWaitlist" class="w-full p-5 border rounded-2xl font-bold"></div>

                        <div class="lg:col-span-4 p-8 bg-slate-50 rounded-3xl border border-slate-200 mt-6 shadow-inner">
                            <label class="text-sm font-black text-slate-600 uppercase tracking-widest mb-6 block border-b pb-4">
                                <i data-lucide="hammer" class="w-5 h-5 inline mr-2 text-blue-500"></i> 開放租借項目 (多選)
                            </label>
                            <div id="equipSelectArea" class="flex flex-wrap gap-6"></div>
                        </div>

                        <div class="lg:col-span-4 flex justify-end gap-6 border-t pt-10 mt-6">
                            <button id="btnCancelEdit" onclick="clearCourseForm()" class="hidden px-12 py-5 bg-slate-100 text-slate-500 font-black rounded-2xl uppercase btn-active">取消編輯</button>
                            <button onclick="processCourseSubmission()" class="bg-[#06C755] text-white px-24 py-5 rounded-2xl font-black shadow-2xl uppercase tracking-[0.2em] text-xl btn-active">儲存並同步雲端</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 bg-slate-50 flex justify-between items-center px-10">
                        <span class="font-black text-xs text-slate-400 uppercase tracking-widest">目前在線課程清單</span>
                        <button onclick="loadCourses()" class="text-[#06C755] hover:underline flex items-center gap-2"><i data-lucide="refresh-cw" class="w-4 h-4"></i> 重新同步</button>
                    </div>
                    <div class="overflow-x-auto px-4 pb-4">
                        <table class="w-full text-left text-base">
                            <thead class="bg-white border-b text-slate-400 font-black uppercase">
                                <tr>
                                    <th class="px-10 py-6">課程內容</th>
                                    <th class="px-10 py-6 text-center">價格</th>
                                    <th class="px-10 py-6 text-right">管理</th>
                                </tr>
                            </thead>
                            <tbody id="courseTableBody" class="divide-y text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab: Settings -->
            <div id="tabSettings" class="tab-content">
                <div class="max-w-3xl bg-white p-12 rounded-3xl border border-slate-200 shadow-xl space-y-10">
                    <section class="border-b pb-10">
                        <h3 class="font-black text-2xl text-slate-800 flex items-center gap-3 italic uppercase mb-8"><i data-lucide="link-2" class="text-blue-500"></i> API 雲端連線</h3>
                        <input type="text" id="apiUrlInput" class="w-full p-6 bg-slate-900 text-green-400 rounded-2xl font-mono text-sm shadow-2xl outline-none" placeholder="Paste GAS URL here...">
                    </section>
                    <button onclick="saveApiUrl()" class="w-full py-6 bg-green-600 text-white font-black rounded-2xl uppercase shadow-2xl text-lg btn-active">儲存 API 並重新載入</button>
                </div>
            </div>

            <!-- Tab: Members -->
            <div id="tabMembers" class="tab-content">
                <div class="bg-white rounded-3xl shadow-sm border p-20 text-center text-slate-300 font-black uppercase italic tracking-widest">
                    <i data-lucide="users" class="w-16 h-16 mx-auto mb-6 opacity-20"></i>
                    會員名冊模組載入中...
                </div>
            </div>

        </main>
    </div>

    <!-- Logic Engine -->
    <script>
        let endpointUrl = localStorage.getItem('sportflow_api_url') || '';
        let globalEquips = []; let globalCourses = [];

        window.onload = () => { 
            lucide.createIcons(); 
            document.getElementById('apiUrlInput').value = endpointUrl; 
            if(endpointUrl) { 
                document.getElementById('apiStatusDot').style.backgroundColor = '#06C755'; 
                refreshDashboard(); loadCourses(); preloadEquipData(); 
            } else { switchTab('settings'); } 
        };

        function toggleSidebar() {
            const sidebar = document.getElementById('appSidebar');
            const icon = document.getElementById('toggleIcon');
            sidebar.classList.toggle('w-64');
            sidebar.classList.toggle('w-20');
            sidebar.classList.toggle('collapsed');
            
            // 更換 Icon 狀態 (選做: 切換為收合/展開圖示)
            // if(sidebar.classList.contains('collapsed')) icon.setAttribute('data-lucide', 'arrow-right-to-line');
            // else icon.setAttribute('data-lucide', 'menu');
            // lucide.createIcons();
        }

        function switchTab(id) { 
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); 
            document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1)).classList.add('active'); 
            document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('nav-active', n.dataset.tab === id)); 
            document.getElementById('tabTitle').innerText = (id === 'members') ? '會員名冊' : (id === 'courses') ? '課程建置' : id.toUpperCase(); 
            lucide.createIcons(); 
        }

        function showLoading(show) { document.getElementById('loadingIndicator').classList.toggle('hidden', !show); }
        
        function previewImg(type, url) { 
            const box = document.getElementById('pre' + type.charAt(0).toUpperCase() + type.slice(1)); 
            box.innerHTML = (url && url.startsWith('http')) ? `<img src="${url}" class="w-full h-full object-cover rounded-xl shadow-sm">` : `<i data-lucide="image" class="w-10 h-10 opacity-10"></i>`; 
            lucide.createIcons(); 
        }

        async function fetchApi(action, params = {}) { 
            if(!endpointUrl) return {success:false}; 
            showLoading(true); 
            try { 
                const q = new URLSearchParams({ action, ...params }).toString(); 
                const r = await fetch(`${endpointUrl}?${q}`); 
                return await r.json(); 
            } catch(e) { return {success:false, error:e.toString()}; } finally { showLoading(false); } 
        }

        async function preloadEquipData() { 
            const res = await fetchApi('getEquipment'); 
            if(res && res.length > 0) { 
                globalEquips = res; 
                document.getElementById('equipSelectArea').innerHTML = res.map(e => `
                    <label class="flex items-center gap-3 bg-white border border-slate-200 px-6 py-4 rounded-2xl cursor-pointer hover:border-green-400 transition-all">
                        <input type="checkbox" name="chkEquip" value="${e.id}" class="w-6 h-6 accent-[#06C755]">
                        <div class="flex flex-col"><span class="text-base font-black text-slate-700">${e.name}</span><span class="text-xs text-slate-400">$${e.fee}</span></div>
                    </label>`).join(''); 
            } 
        }

        async function loadCourses() { 
            const res = await fetchApi('getCourses'); 
            if(res && res.length > 0) { 
                globalCourses = res; 
                document.getElementById('courseTableBody').innerHTML = res.map(c => `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-10 py-8 flex items-center gap-8">
                            <img src="${c.coverUrl || 'https://via.placeholder.com/120x80'}" class="w-32 h-20 object-cover rounded-2xl border-2 border-white shadow-md">
                            <div>
                                <div class="font-black text-slate-800 text-2xl uppercase tracking-tighter underline decoration-green-400 decoration-4 underline-offset-4 mb-2">${c.name}</div>
                                <div class="text-sm text-slate-400 font-bold uppercase tracking-widest">${c.date} | ${c.coach}</div>
                            </div>
                        </td>
                        <td class="px-10 py-8 text-center">
                            <div class="text-slate-300 line-through text-xs font-black mb-1">$${c.price}</div>
                            <div class="text-red-500 text-3xl font-black tracking-tighter">$${c.earlyPrice || c.price}</div>
                        </td>
                        <td class="px-10 py-8 text-right">
                            <div class="flex justify-end gap-5">
                                <button onclick="initEditCourse('${c.id}')" class="p-4 bg-amber-50 text-amber-500 rounded-2xl hover:bg-amber-100 shadow-sm transition-all"><i data-lucide="edit-3" class="w-6 h-6"></i></button>
                                <button onclick="deleteCourseRecord('${c.id}')" class="p-4 bg-red-50 text-red-500 rounded-2xl hover:bg-red-100 shadow-sm transition-all"><i data-lucide="trash-2" class="w-6 h-6"></i></button>
                            </div>
                        </td>
                    </tr>`).join(''); 
                lucide.createIcons(); 
            } 
        }
        
        function initEditCourse(id) {
            const c = globalCourses.find(x => x.id === id); if(!c) return;
            document.getElementById('courseFormBlock').classList.add('edit-mode');
            document.getElementById('editBadge').classList.remove('hidden');
            document.getElementById('btnCancelEdit').classList.remove('hidden');
            document.getElementById('formTitle').innerHTML = '<i data-lucide="edit-3" class="w-10 h-10 text-amber-500"></i> 更新活動詳情';
            
            document.getElementById('fieldId').value = c.id; 
            document.getElementById('fieldName').value = c.name;
            document.getElementById('fieldLevelReq').value = c.levelReq || '初級'; 
            document.getElementById('fieldCoach').value = c.coach;
            document.getElementById('fieldDate').value = c.date; 
            document.getElementById('fieldTime').value = c.time;
            document.getElementById('fieldPrice').value = c.price; 
            document.getElementById('fieldEarlyPrice').value = c.earlyPrice;
            document.getElementById('fieldEarlyDeadline').value = c.earlyDeadline; 
            document.getElementById('fieldSlots').value = c.slots;
            document.getElementById('fieldWaitlist').value = c.waitlist; 
            document.getElementById('fieldCoverUrl').value = c.coverUrl;
            document.getElementById('fieldDescImgUrl').value = c.descImgUrl;
            
            const eArr = (c.equipData || '').split(','); 
            document.querySelectorAll('input[name="chkEquip"]').forEach(cb => cb.checked = eArr.includes(cb.value));
            
            previewImg('cover', c.coverUrl); previewImg('desc', c.descImgUrl);
            document.getElementById('scrollArea').scrollTo({ top: 0, behavior: 'smooth' });
            lucide.createIcons();
        }

        function clearCourseForm() { 
            document.getElementById('courseFormBlock').classList.remove('edit-mode'); 
            document.getElementById('editBadge').classList.add('hidden'); 
            document.getElementById('btnCancelEdit').classList.add('hidden'); 
            document.getElementById('formTitle').innerHTML = '<i data-lucide="plus-circle" class="w-10 h-10 text-green-500"></i> 建立新課程活動';
            document.getElementById('fieldId').value = ''; document.getElementById('fieldName').value = ''; 
            document.querySelectorAll('input[name="chkEquip"]').forEach(cb => cb.checked = false); 
            previewImg('cover',''); previewImg('desc',''); 
            lucide.createIcons();
        }

        async function processCourseSubmission() {
            const id = document.getElementById('fieldId').value;
            const equipIds = Array.from(document.querySelectorAll('input[name="chkEquip"]:checked')).map(el => el.value);
            const data = { id, name: document.getElementById('fieldName').value, levelReq: document.getElementById('fieldLevelReq').value, coach: document.getElementById('fieldCoach').value, date: document.getElementById('fieldDate').value, time: document.getElementById('fieldTime').value, price: document.getElementById('fieldPrice').value, earlyPrice: document.getElementById('fieldEarlyPrice').value, earlyDeadline: document.getElementById('fieldEarlyDeadline').value, slots: document.getElementById('fieldSlots').value, waitlist: document.getElementById('fieldWaitlist').value, equipData: equipIds.join(','), coverUrl: document.getElementById('fieldCoverUrl').value, descImgUrl: document.getElementById('fieldDescImgUrl').value };
            if(!data.name || !data.date) return alert('請填寫必要欄位');
            const res = await fetchApi(id ? 'updateCourse' : 'addCourse', data);
            if(res.success) { alert('✅ 成功發布至雲端！'); clearCourseForm(); loadCourses(); refreshDashboard(); }
        }

        async function deleteCourseRecord(id) { if(!confirm('確認永久刪除？')) return; const res = await fetchApi('deleteCourse', { id }); if(res.success) loadCourses(); }
        async function refreshStats() { const res = await fetchApi('getStats'); if(res.success) { document.getElementById('statMembers').innerText = res.stats.members; document.getElementById('statCourses').innerText = res.stats.courses; } }
        async function saveApiUrl() { endpointUrl = document.getElementById('apiUrlInput').value.trim(); localStorage.setItem('sportflow_api_url', endpointUrl); location.reload(); }
    </script>
</body>
</html>
