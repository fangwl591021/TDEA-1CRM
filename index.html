<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Island | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --line-green: #06C755; --line-dark: #0f172a; --line-bg: #f8fafc; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--line-bg); }
        .nav-active { background-color: #1e293b; color: var(--line-green); border-left: 4px solid var(--line-green); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .img-preview { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; background-color: #e2e8f0; display: flex; align-items: center; justify-content: center; }
        .edit-mode { border: 2px solid #fbbf24; background-color: #fffbeb; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-[#0f172a] text-white flex flex-col h-full shadow-xl z-20 shrink-0">
        <div class="p-6 flex items-center gap-3 border-b border-slate-800">
            <div class="w-10 h-10 bg-[#06C755] rounded-xl flex items-center justify-center font-bold text-white shadow-lg text-2xl font-sans">S</div>
            <span class="font-black text-xl tracking-tighter uppercase italic">Sports Island</span>
        </div>
        <nav class="flex-1 mt-4 overflow-y-auto no-scrollbar">
            <a href="javascript:void(0)" onclick="switchTab('dashboard')" class="nav-item nav-active flex items-center gap-4 px-6 py-4" data-tab="dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="font-bold uppercase text-[10px]">Dashboard</span>
            </a>
            <a href="javascript:void(0)" onclick="switchTab('members')" class="nav-item flex items-center gap-4 px-6 py-4 text-slate-400" data-tab="members">
                <i data-lucide="users" class="w-5 h-5"></i><span class="font-bold uppercase text-[10px]">Members</span>
            </a>
            <a href="javascript:void(0)" onclick="switchTab('courses')" class="nav-item flex items-center gap-4 px-6 py-4 text-slate-400" data-tab="courses">
                <i data-lucide="calendar" class="w-5 h-5"></i><span class="font-bold uppercase text-[10px]">Courses</span>
            </a>
            <div class="border-t border-slate-800 my-4 mx-4"></div>
            <a href="javascript:void(0)" onclick="switchTab('settings')" class="nav-item flex items-center gap-4 px-6 py-4 text-slate-400" data-tab="settings">
                <i data-lucide="settings" class="w-5 h-5 text-slate-200"></i><span class="font-bold uppercase text-[10px]">Settings</span>
            </a>
        </nav>
        <div class="p-4 border-t border-slate-800 text-[9px] text-slate-500 text-center font-black uppercase">V3.7 Admin</div>
    </aside>

    <!-- Main Workspace -->
    <div class="flex-1 flex flex-col min-w-0 relative">
        <header class="h-20 bg-white shadow-sm flex items-center justify-between px-8 shrink-0 z-10 border-b">
            <div class="flex items-center gap-6">
                <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-100 rounded-md text-slate-500"><i data-lucide="menu" class="w-7 h-7"></i></button>
                <h2 id="tabTitle" class="text-2xl font-black text-slate-800 tracking-tight uppercase italic">Dashboard</h2>
                <div id="loading" class="hidden flex items-center gap-2 text-xs text-green-500 italic ml-4 font-bold tracking-widest uppercase">Syncing...</div>
            </div>
            <div id="apiStatus" class="w-3 h-3 rounded-full bg-red-500 shadow-sm animate-pulse mr-8"></div>
        </header>

        <main id="scrollArea" class="flex-1 overflow-y-auto p-8 md:p-12">
            
            <div id="tabDashboard" class="tab-content active space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-6">
                        <div class="p-4 bg-green-50 text-green-500 rounded-2xl shadow-inner"><i data-lucide="users" class="w-8 h-8"></i></div>
                        <div><p class="text-[10px] text-slate-400 font-black uppercase">Total Members</p><h3 id="statMembers" class="text-4xl font-black text-slate-800 tracking-tighter">--</h3></div>
                    </div>
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-6">
                        <div class="p-4 bg-blue-50 text-blue-500 rounded-2xl shadow-inner"><i data-lucide="calendar" class="w-8 h-8"></i></div>
                        <div><p class="text-[10px] text-slate-400 font-black uppercase">Live Courses</p><h3 id="statCourses" class="text-4xl font-black text-slate-800 tracking-tighter">--</h3></div>
                    </div>
                </div>
            </div>

            <div id="tabCourses" class="tab-content space-y-8">
                <div id="courseForm" class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex items-center justify-between mb-8 border-b pb-4">
                        <h3 id="formTitle" class="font-black text-xl text-slate-800 flex items-center gap-3 italic uppercase"><i data-lucide="plus-circle" class="w-6 h-6 text-green-500"></i> New Activity</h3>
                        <div id="editBadge" class="hidden text-xs bg-amber-100 text-amber-600 px-4 py-1.5 rounded-full font-black animate-pulse">編輯模式</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                        <input type="hidden" id="fieldId">
                        <div class="lg:col-span-2"><label class="text-[10px] font-black text-slate-400 uppercase">課程名稱</label><input type="text" id="fieldName" class="w-full p-4 border rounded-xl font-black"></div>
                        <div><label class="text-[10px] font-black text-slate-400 uppercase">等級要求</label><select id="fieldLevelReq" class="w-full p-4 border rounded-xl"><option value="初級">初級</option><option value="進階">進階</option><option value="高級">高級</option></select></div>
                        <div><label class="text-[10px] font-black text-slate-400 uppercase">授課教練</label><input type="text" id="fieldCoach" class="w-full p-4 border rounded-xl"></div>
                        <div class="lg:col-span-2"><label class="text-[10px] font-black text-slate-400 uppercase">封面網址</label><input type="text" id="fieldCoverUrl" oninput="preview('cover', this.value)" class="w-full p-4 bg-slate-50 border rounded-xl text-xs font-mono"><div id="preCover" class="img-preview mt-2 border border-dashed"></div></div>
                        <div class="lg:col-span-2"><label class="text-[10px] font-black text-slate-400 uppercase">內容網址</label><input type="text" id="fieldDescUrl" oninput="preview('desc', this.value)" class="w-full p-4 bg-slate-50 border rounded-xl text-xs font-mono"><div id="preDesc" class="img-preview mt-2 border border-dashed"></div></div>
                        <div><label class="text-[10px] font-black text-slate-400 uppercase">日期</label><input type="date" id="fieldDate" class="w-full p-4 border rounded-xl"></div>
                        <div><label class="text-[10px] font-black text-slate-400 uppercase">時段</label><input type="text" id="fieldTime" placeholder="14:00-16:00" class="w-full p-4 border rounded-xl"></div>
                        <div><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest font-black">課程原價</label><input type="number" id="fieldPrice" class="w-full p-4 border rounded-xl font-black"></div>
                        <div><label class="text-[10px] font-black text-red-500 uppercase tracking-widest font-black">早鳥優惠價</label><input type="number" id="fieldEarlyPrice" class="w-full p-4 border border-red-100 bg-red-50/20 rounded-xl outline-none font-black text-red-600"></div>
                        <div class="lg:col-span-2"><label class="text-[10px] font-black text-slate-400 uppercase">早鳥截止</label><input type="datetime-local" id="fieldDeadline" class="w-full p-4 border rounded-xl"></div>
                        <div><label class="text-[10px] font-black text-slate-400 uppercase">名額</label><input type="number" id="fieldSlots" class="w-full p-4 border rounded-xl"></div>
                        <div><label class="text-[10px] font-black text-slate-400 uppercase">候補</label><input type="number" id="fieldWait" class="w-full p-4 border rounded-xl"></div>
                        <div class="lg:col-span-4 p-6 bg-slate-50 rounded-xl border"><label class="text-[10px] font-black text-slate-600 uppercase mb-4 block">設備租借項目</label><div id="equipList" class="flex flex-wrap gap-4"></div></div>
                        <div class="lg:col-span-4 flex justify-end gap-4"><button id="btnCancel" onclick="resetForm()" class="hidden px-8 py-4 bg-slate-100 font-black rounded-xl uppercase text-xs">Cancel</button><button onclick="submitCourse()" class="bg-[#06C755] text-white px-16 py-4 rounded-xl font-black shadow-xl uppercase text-sm">Save & Publish</button></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-400 font-black uppercase"><tr><th class="px-8 py-4">Course Info</th><th class="px-8 py-4 text-center">Price</th><th class="px-8 py-4 text-right">Actions</th></tr></thead><tbody id="courseTable" class="divide-y"></tbody></table></div>
            </div>

            <div id="tabSettings" class="tab-content"><div class="bg-white p-10 rounded-2xl border space-y-8"><section><h3 class="font-black text-lg border-b pb-4 uppercase italic">GAS API CONFIG</h3><input type="text" id="apiUrlInput" class="w-full p-4 bg-slate-900 text-green-400 rounded-xl font-mono text-xs mt-4"></section><button onclick="saveApi()" class="w-full py-4 bg-green-600 text-white font-black rounded-xl uppercase shadow-lg">Save API URL</button></div></div>
        </main>
    </div>

    <script>
        let endpoint = localStorage.getItem('sportflow_api_url') || '';
        let equips = []; let courses = [];

        window.onload = () => { lucide.createIcons(); document.getElementById('apiUrlInput').value = endpoint; if(endpoint) { refreshStats(); loadCourses(); loadEquips(); document.getElementById('apiStatus').style.backgroundColor = '#06C755'; } };
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1)).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('nav-active', n.dataset.tab === id)); document.getElementById('tabTitle').innerText = id.toUpperCase(); lucide.createIcons(); }
        function showLoading(s) { document.getElementById('loading').classList.toggle('hidden', !s); }
        function preview(t, u) { const b = document.getElementById('pre' + t.charAt(0).toUpperCase() + t.slice(1)); b.innerHTML = (u && u.startsWith('http')) ? `<img src="${u}" class="w-full h-full object-cover rounded-lg">` : `<i data-lucide="image" class="w-6 h-6 opacity-10"></i>`; lucide.createIcons(); }
        
        async function call(a, p = {}) { if(!endpoint) return {success:false}; showLoading(true); try { const q = new URLSearchParams({ action: a, ...p }).toString(); const r = await fetch(`${endpoint}?${q}`); return await r.json(); } finally { showLoading(false); } }
        async function loadEquips() { const r = await call('getEquipment'); if(r && r.length > 0) { equips = r; document.getElementById('equipList').innerHTML = r.map(e => `<label class="flex items-center gap-2 bg-white border p-3 rounded-xl cursor-pointer"><input type="checkbox" name="chkEquip" value="${e.id}" class="accent-[#06C755]"><span class="text-xs font-bold text-slate-700">${e.name}</span></label>`).join(''); } }
        async function loadCourses() { const r = await call('getCourses'); if(r && r.length > 0) { courses = r; document.getElementById('courseTable').innerHTML = r.map(c => `<tr class="hover:bg-slate-50"><td class="px-8 py-6 flex items-center gap-4"><img src="${c.coverUrl || 'https://via.placeholder.com/60x40'}" class="w-16 h-12 object-cover rounded-lg border"><div><div class="font-black uppercase">${c.name}</div><div class="text-[10px] text-slate-300 font-bold">${c.date} | ${c.coach}</div></div></td><td class="px-8 py-6 text-center font-black text-red-500">$${c.earlyPrice || c.price}</td><td class="px-8 py-6 text-right"><div class="flex justify-end gap-2"><button onclick="startEdit('${c.id}')" class="p-2 bg-amber-50 text-amber-500 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button onclick="deleteCourse('${c.id}')" class="p-2 bg-red-50 text-red-400 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td></tr>`).join(''); lucide.createIcons(); } }
        function startEdit(id) {
            const c = courses.find(x => x.id === id); if(!c) return;
            document.getElementById('courseForm').classList.add('edit-mode');
            document.getElementById('editBadge').classList.remove('hidden');
            document.getElementById('btnCancel').classList.remove('hidden');
            document.getElementById('fieldId').value = c.id; document.getElementById('fieldName').value = c.name;
            document.getElementById('fieldLevelReq').value = c.levelReq; document.getElementById('fieldCoach').value = c.coach;
            document.getElementById('fieldDate').value = c.date; document.getElementById('fieldTime').value = c.time;
            document.getElementById('fieldPrice').value = c.price; document.getElementById('fieldEarlyPrice').value = c.earlyPrice;
            document.getElementById('fieldDeadline').value = c.earlyDeadline; document.getElementById('fieldSlots').value = c.slots;
            document.getElementById('fieldWait').value = c.waitlist; document.getElementById('fieldCoverUrl').value = c.coverUrl;
            document.getElementById('fieldDescUrl').value = c.descImgUrl;
            const eArr = (c.equipData || '').split(','); document.querySelectorAll('input[name="chkEquip"]').forEach(cb => cb.checked = eArr.includes(cb.value));
            preview('cover', c.coverUrl); preview('desc', c.descImgUrl);
            document.getElementById('scrollArea').scrollTo({ top: 0, behavior: 'smooth' });
        }
        function resetForm() { document.getElementById('courseForm').classList.remove('edit-mode'); document.getElementById('editBadge').classList.add('hidden'); document.getElementById('btnCancel').classList.add('hidden'); document.getElementById('fieldId').value = ''; document.getElementById('fieldName').value = ''; document.querySelectorAll('input[name="chkEquip"]').forEach(cb => cb.checked = false); preview('cover',''); preview('desc',''); }
        async function submitCourse() {
            const id = document.getElementById('fieldId').value;
            const eIds = Array.from(document.querySelectorAll('input[name="chkEquip"]:checked')).map(el => el.value);
            const p = { id: id, name: document.getElementById('fieldName').value, levelReq: document.getElementById('fieldLevelReq').value, coach: document.getElementById('fieldCoach').value, date: document.getElementById('fieldDate').value, time: document.getElementById('fieldTime').value, price: document.getElementById('fieldPrice').value, earlyPrice: document.getElementById('fieldEarlyPrice').value, earlyDeadline: document.getElementById('fieldDeadline').value, slots: document.getElementById('fieldSlots').value, waitlist: document.getElementById('fieldWait').value, equipData: eIds.join(','), coverUrl: document.getElementById('fieldCoverUrl').value, descImgUrl: document.getElementById('fieldDescUrl').value };
            const r = await call(id ? 'updateCourse' : 'addCourse', p);
            if(r.success) { alert('Done!'); resetForm(); loadCourses(); refreshStats(); }
        }
        async function deleteCourse(id) { if(!confirm('Delete?')) return; const r = await call('deleteCourse', { id: id }); if(r.success) loadCourses(); }
        async function refreshStats() { const r = await call('getStats'); if(r.success) { document.getElementById('statMembers').innerText = r.stats.members; document.getElementById('statCourses').innerText = r.stats.courses; } }
        async function saveApi() { endpoint = document.getElementById('apiUrlInput').value.trim(); localStorage.setItem('sportflow_api_url', endpoint); alert('Saved!'); location.reload(); }
        function toggleSidebar() { const s = document.getElementById('sidebar'); s.classList.toggle('w-64'); s.classList.toggle('w-20'); }
    </script>
</body>
</html>
