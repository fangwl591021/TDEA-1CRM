<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Enterprise</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;700&display=swap');
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #ffffff; color: #333; margin: 0; }
    * { border-radius: 0 !important; }
    .sidebar-bg { background-color: #1a1a1a; }
    .sidebar-item:hover { background-color: #2a2a2a; }
    .sidebar-active { background-color: #06C755 !important; color: #fff !important; }
    .crm-table { width: 100%; border-collapse: collapse; }
    .crm-table th { background-color: #f1f3f5; border: 1px solid #dee2e6; padding: 10px 12px; font-size: 13px; font-weight: 700; color: #495057; text-align: left; position: sticky; top: 0; z-index: 10; }
    .crm-table td { border: 1px solid #dee2e6; padding: 8px 12px; font-size: 13px; white-space: nowrap; }
    .crm-table tr:hover { background-color: #f8f9fa; }
    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); border-top: 1px solid #dee2e6; border-left: 1px solid #dee2e6; }
    .detail-cell { display: flex; border-bottom: 1px solid #dee2e6; border-right: 1px solid #dee2e6; min-height: 44px; }
    .detail-label { width: 160px; background-color: #f8f9fa; border-right: 1px solid #dee2e6; padding: 10px 15px; font-size: 11px; font-weight: 700; color: #666; flex-shrink: 0; display: flex; align-items: center; }
    .detail-value { flex-grow: 1; display: flex; align-items: center; }
    .detail-input { width: 100%; height: 100%; padding: 0 15px; border: none; font-size: 14px; outline: none; }
    .detail-input:focus { background-color: #fffde7; }
    .detail-input:disabled { background-color: #f1f3f5; color: #999; cursor: not-allowed; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const CONFIG = { GAS_URL: window.CRM_CONFIG?.GAS_URL || "" };

    const Icon = ({ name, size = 18, className = "" }) => {
      const paths = {
        dashboard: "M3 3h7v7H3V3zm11 0h7v7h-7V3zm0 11h7v7h-7v-7zm-11 0h7v7H3v-7z",
        calendar: "M8 7V3m8 4V3M3 11h18M5 5h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z",
        users: "M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2m12-17a4 4 0 11-8 0 4 4 0 018 0zm6 17v-2a4 4 0 00-3-3.87m-4-12a4 4 0 010 7.75",
        menu: "M3 12h18M3 6h18M3 18h18",
        building: "M3 21h18M3 7v14m18-14v14M3 7l9-4 9 4M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6",
        save: "M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z",
        back: "M15 18l-6-6 6-6"
      };
      return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d={paths[name] || ""} /></svg>;
    };

    const App = () => {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [stats, setStats] = useState({ association: 0, vendor: 0, general: 0, activities: 0 });
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(false);
      const [editingItem, setEditingItem] = useState(null);

      const callApi = async (action, params = {}) => {
        if (!CONFIG.GAS_URL) return { success: false, error: "Missing GAS_URL" };
        const query = new URLSearchParams({ action, ...params }).toString();
        const res = await fetch(`${CONFIG.GAS_URL}?${query}`);
        return await res.json();
      };

      const loadList = async (type) => {
        setLoading(true); setEditingItem(null); setActiveTab(type);
        const res = await callApi('getMembers', { type });
        if (res.success) setData(res.data);
        setLoading(false);
      };

      useEffect(() => {
        if (activeTab === 'dashboard') callApi('getDashboard').then(res => res.success && setStats(res.counts));
      }, [activeTab]);

      return (
        <div className="flex h-screen overflow-hidden bg-white text-sm">
          <aside className="w-52 sidebar-bg flex flex-col shrink-0 z-20">
            <div className="h-12 flex items-center px-4 border-b border-white/10 text-white font-bold uppercase text-xs tracking-widest">CRM ADMIN</div>
            <nav className="flex-1 mt-2">
              <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center space-x-3 px-4 py-4 ${activeTab==='dashboard'?'sidebar-active':'text-gray-400'}`}><Icon name="dashboard" /><span>儀表板</span></button>
              <div className="px-4 py-3 text-[10px] text-gray-600 font-bold uppercase tracking-widest">資料模組</div>
              <button onClick={() => loadList('association')} className={`w-full flex items-center space-x-3 px-4 py-4 ${activeTab==='association'?'sidebar-active':'text-gray-400'}`}><Icon name="building" /><span>本業會員</span></button>
              <button onClick={() => loadList('vendor')} className={`w-full flex items-center space-x-3 px-4 py-4 ${activeTab==='vendor'?'sidebar-active':'text-gray-400'}`}><Icon name="users" /><span>廠商會員</span></button>
              <button onClick={() => loadList('general')} className={`w-full flex items-center space-x-3 px-4 py-4 ${activeTab==='general'?'sidebar-active':'text-gray-400'}`}><Icon name="users" /><span>一般會員</span></button>
            </nav>
          </aside>

          <main className="flex-1 flex flex-col overflow-hidden relative">
            <header className="h-12 border-b flex items-center px-4 bg-white shrink-0 font-bold uppercase text-[10px] text-gray-400 tracking-widest">
              {CONFIG.GAS_URL ? "CONNECTED" : "OFFLINE"} / {activeTab}
            </header>
            <div className="flex-1 overflow-auto">
              {loading ? <div className="flex items-center justify-center h-full text-gray-300 animate-pulse font-bold tracking-widest">SYNCING...</div> :
               editingItem ? (
                 <div className="h-full flex flex-col bg-[#f1f3f5]">
                   <div className="p-4 bg-white border-b flex justify-between items-center sticky top-0 z-20 shadow-sm">
                     <button onClick={() => setEditingItem(null)} className="p-2 border flex items-center space-x-2 text-xs font-bold"><Icon name="back" size={14}/><span>返回清單</span></button>
                     <button onClick={async () => {
                       setLoading(true);
                       const res = await callApi('updateData', { type: activeTab, data: JSON.stringify(editingItem) });
                       if(res.success) { setData(prev => prev.map(i => i.序號 === editingItem.序號 ? editingItem : i)); setEditingItem(null); }
                       setLoading(false);
                     }} className="bg-[#06C755] text-white px-10 py-2 text-xs font-bold flex items-center space-x-2 shadow-md"><Icon name="save" size={14}/><span>儲存更新</span></button>
                   </div>
                   <div className="flex-1 p-8 overflow-auto"><div className="max-w-6xl mx-auto bg-white border border-gray-300"><div className="detail-grid">
                     {Object.keys(editingItem).map(k => (
                       <div key={k} className="detail-cell"><div className="detail-label">{k}</div><div className="detail-value"><input className="detail-input" value={editingItem[k]||''} onChange={e=>setEditingItem({...editingItem,[k]:e.target.value})} disabled={k==='序號'||k==='會員編號'||k==='userid'} /></div></div>
                     ))}
                   </div></div></div>
                 </div>
               ) : activeTab === 'dashboard' ? (
                 <div className="grid grid-cols-1 md:grid-cols-4 border-b">
                   <DashBox title="本業會員" count={stats.association} color="border-blue-500" /><DashBox title="廠商會員" count={stats.vendor} color="border-orange-500" /><DashBox title="一般會員" count={stats.general} color="border-green-500" /><DashBox title="活動總計" count={stats.activities} color="border-purple-500" />
                 </div>
               ) : (
                 <table className="crm-table">
                   <thead><tr>{data.length > 0 && Object.keys(data[0]).filter(k=>k!=='MAIL').slice(0,10).map(k=><th key={k}>{k}</th>)}<th className="text-center sticky right-0 bg-[#f1f3f5] border-l">操作</th></tr></thead>
                   <tbody>{data.map((r,i)=>(<tr key={i}>{Object.keys(r).filter(k=>k!=='MAIL').slice(0,10).map((k,j)=><td key={j}>{String(r[k])}</td>)}<td className="text-center sticky right-0 bg-white border-l"><button onClick={()=>setEditingItem(r)} className="text-blue-600 font-bold text-xs hover:underline">編輯詳細</button></td></tr>))}</tbody>
                 </table>
               )}
            </div>
          </main>
        </div>
      );
    };

    const DashBox = ({ title, count, color }) => (<div className={`p-10 border-r last:border-r-0 border-b-8 ${color} hover:bg-gray-50`}><div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">{title}</div><div className="text-4xl font-black">{count.toLocaleString()}</div></div>);
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
