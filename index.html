<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TDEA CRM - LINE OA Manager</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #F4F5F7; color: #333; margin: 0; }
    
    /* 規格鎖定：無圓角 */
    * { border-radius: 0 !important; }
    .line-green { color: #06C755; }
    .line-green-bg { background-color: #06C755; }
    .line-green-border { border-color: #06C755; }
    
    /* 側邊欄 */
    .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .sidebar-light { background-color: #F8F9FA; border-right: 1px solid #E5E7EB; }
    .sidebar-item { color: #555; white-space: nowrap; overflow: hidden; }
    .sidebar-active { background-color: #FFFFFF; color: #06C755 !important; border-left: 4px solid #06C755; font-weight: 700; }
    
    /* 表格與格線 */
    .crm-table { width: 100%; border-collapse: collapse; background: white; }
    .crm-table th { background-color: #F9FAFB; border-bottom: 2px solid #E5E7EB; padding: 12px 15px; font-size: 13px; color: #6B7280; text-align: left; position: sticky; top: 0; z-index: 10; }
    .crm-table td { border-bottom: 1px solid #F3F4F6; padding: 10px 15px; font-size: 13px; }
    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); border: 1px solid #E5E7EB; }
    .detail-label { width: 150px; background-color: #F9FAFB; border-right: 1px solid #E5E7EB; padding: 12px; font-size: 12px; font-weight: 700; color: #4B5563; }
    .detail-input { width: 100%; padding: 8px 12px; font-size: 14px; border: none; outline: none; background: white; }
    .detail-input:focus { background-color: #F0FDF4; }

    /* 動畫區域 */
    .collapsible-stats { transition: max-height 0.3s ease-in-out, opacity 0.2s; overflow: hidden; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #D1D5DB; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const LIFF_ID = "2005868456-Rt5YK7qL";
    const CONFIG = { GAS_URL: window.CRM_CONFIG?.GAS_URL || "" };

    const Icon = ({ name, size = 18, className = "" }) => {
      const paths = {
        home: "M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6",
        users: "M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z",
        lock: "M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z",
        chevronLeft: "M15 19l-7-7 7-7",
        chevronRight: "M9 5l7 7-7 7",
        chevronUp: "M18 15l-6-6-6 6",
        chevronDown: "M6 9l6 6 6-6",
        save: "M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z",
        search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
      };
      return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={paths[name] || ""} /></svg>;
    };

    const App = () => {
      const [authStatus, setAuthStatus] = useState('loading'); // loading, unauthorized, authorized
      const [userProfile, setUserProfile] = useState(null);
      const [activeTab, setActiveTab] = useState('dashboard');
      const [isSidebarCollapsed, setSidebarCollapsed] = useState(false);
      const [isStatsExpanded, setStatsExpanded] = useState(true);
      const [stats, setStats] = useState({ association: 0, vendor: 0, general: 0, activities: 0 });
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(false);
      const [editingItem, setEditingItem] = useState(null);
      
      // 綁定表單狀態
      const [bindType, setBindType] = useState('本業會員');
      const [bindMid, setBindMid] = useState('');
      const [bindPhone, setBindPhone] = useState('');

      useEffect(() => {
        initLiff();
      }, []);

      const initLiff = async () => {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) { liff.login(); return; }
          const profile = await liff.getProfile();
          setUserProfile(profile);
          checkAuth(profile.userId);
        } catch (e) { console.error("LIFF Error", e); setAuthStatus('unauthorized'); }
      };

      const checkAuth = async (uid) => {
        const res = await callApi('check', { userId: uid });
        if (res.status === 'admin' || res.status === 'member') {
          setAuthStatus('authorized');
          loadDashboard();
        } else {
          setAuthStatus('unauthorized');
        }
      };

      const callApi = async (action, params = {}) => {
        if (!CONFIG.GAS_URL) return { success: true, counts: { association: 142, vendor: 56, general: 1205, activities: 8 }, data: [] };
        try {
          const res = await fetch(`${CONFIG.GAS_URL}?${new URLSearchParams({ action, ...params })}`);
          return await res.json();
        } catch (e) { return { success: false }; }
      };

      const loadDashboard = async () => {
        const r = await callApi('getDashboard');
        if (r.success) setStats(r.counts);
      };

      const loadList = async (type) => {
        setLoading(true); setEditingItem(null); setActiveTab(type);
        const r = await callApi('getMembers', { type });
        if (r.success) setData(r.data);
        setLoading(false);
      };

      const handleBind = async () => {
        if (!bindPhone) return alert("請輸入手機號碼");
        setLoading(true);
        const r = await callApi('bindMember', { 
          userId: userProfile.userId, 
          type: bindType, 
          memberId: bindMid, 
          phone: bindPhone, 
          name: userProfile.displayName 
        });
        if (r.success) { alert("綁定成功！"); checkAuth(userProfile.userId); }
        else { alert("綁定失敗：" + r.message); }
        setLoading(false);
      };

      // --- 1. 載入中畫面 ---
      if (authStatus === 'loading') {
        return (
          <div className="h-screen flex flex-col items-center justify-center bg-[#F4F5F7]">
            <div className="w-12 h-12 border-4 border-gray-200 border-t-[#06C755] animate-spin mb-4"></div>
            <span className="text-gray-400 font-bold tracking-widest text-xs">系統身分驗證中...</span>
          </div>
        );
      }

      // --- 2. 登入/綁定畫面 (符合 LINE OA 淺色風格 & 0 圓角) ---
      if (authStatus === 'unauthorized') {
        return (
          <div className="h-screen flex items-center justify-center bg-[#F4F5F7] p-6">
            <div className="w-full max-w-md bg-white border border-gray-200 shadow-sm">
              <div className="p-8 border-b border-gray-100 text-center">
                <div className="w-16 h-16 line-green-bg flex items-center justify-center mx-auto mb-4">
                  <Icon name="lock" size={32} className="text-white" />
                </div>
                <h1 className="text-xl font-bold text-gray-800">會員身分綁定</h1>
                <p className="text-xs text-gray-400 mt-2">請驗證您的資料以進入管理系統</p>
              </div>
              <div className="p-8 space-y-6">
                <div className="flex items-center space-x-3 bg-gray-50 p-3 border border-gray-200">
                  <img src={userProfile?.pictureUrl} className="w-10 h-10 border border-gray-200" />
                  <span className="font-bold text-gray-700">{userProfile?.displayName}</span>
                </div>
                <div className="grid grid-cols-3 gap-0">
                  {['本業會員', '廠商會員', '一般會員'].map(t => (
                    <button 
                      key={t} onClick={() => setBindType(t)}
                      className={`py-3 text-xs font-bold border ${bindType === t ? 'line-green-bg text-white border-[#06C755]' : 'bg-white text-gray-400 border-gray-200'}`}
                    >
                      {t.replace('會員','')}
                    </button>
                  ))}
                </div>
                {bindType !== '一般會員' && (
                  <div>
                    <label className="text-[10px] font-bold text-gray-400 uppercase">會員編號</label>
                    <input value={bindMid} onChange={e => setBindMid(e.target.value)} placeholder="如: A001" className="w-full mt-1 border border-gray-200 px-4 py-3 text-sm focus:line-green-border outline-none" />
                  </div>
                )}
                <div>
                  <label className="text-[10px] font-bold text-gray-400 uppercase">手機號碼</label>
                  <input value={bindPhone} onChange={e => setBindPhone(e.target.value)} placeholder="0912345678" className="w-full mt-1 border border-gray-200 px-4 py-3 text-sm focus:line-green-border outline-none" />
                </div>
                <button 
                  onClick={handleBind} disabled={loading}
                  className="w-full line-green-bg text-white py-4 font-bold text-sm shadow-sm active:scale-[0.98] transition-all"
                >
                  {loading ? "處理中..." : "確認綁定並登入"}
                </button>
              </div>
            </div>
          </div>
        );
      }

      // --- 3. 正式管理介面 ---
      return (
        <div className="flex h-screen overflow-hidden bg-[#F4F5F7]">
          <aside className={`sidebar-light flex flex-col shrink-0 z-20 sidebar-transition ${isSidebarCollapsed ? 'w-16' : 'w-60'}`}>
            <div className="h-16 flex items-center px-4 border-b border-gray-200">
              <div className="w-8 h-8 line-green-bg flex items-center justify-center shrink-0">
                <span className="text-white text-[10px] font-black">CRM</span>
              </div>
              {!isSidebarCollapsed && <span className="ml-3 font-bold text-gray-700 text-sm">管理中心</span>}
            </div>
            <nav className="flex-1 py-4 overflow-y-auto">
              <SidebarLink label="主頁概覽" icon="home" collapsed={isSidebarCollapsed} active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
              {!isSidebarCollapsed && <div className="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest">資料庫</div>}
              <SidebarLink label="本業會員" icon="users" collapsed={isSidebarCollapsed} active={activeTab === 'association'} onClick={() => loadList('association')} />
              <SidebarLink label="廠商會員" icon="users" collapsed={isSidebarCollapsed} active={activeTab === 'vendor'} onClick={() => loadList('vendor')} />
              <SidebarLink label="一般註冊" icon="users" collapsed={isSidebarCollapsed} active={activeTab === 'general'} onClick={() => loadList('general')} />
            </nav>
            <button onClick={() => setSidebarCollapsed(!isSidebarCollapsed)} className="h-12 border-t border-gray-200 flex items-center px-6 text-gray-400 hover:text-[#06C755] transition-colors">
              <Icon name={isSidebarCollapsed ? "chevronRight" : "chevronLeft"} size={16} />
              {!isSidebarCollapsed && <span className="ml-3 text-xs font-bold">收合選單</span>}
            </button>
          </aside>

          <main className="flex-1 flex flex-col overflow-hidden">
            <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0">
              <div className="h-full border-b-2 line-green-border flex items-center px-2">
                <span className="text-sm font-bold line-green uppercase tracking-wide">{activeTab}</span>
              </div>
              <div className="flex items-center space-x-4">
                <div className="flex items-center bg-gray-100 px-3 py-1.5 border border-gray-200">
                  <Icon name="search" size={14} className="text-gray-400 mr-2" />
                  <input type="text" placeholder="搜尋..." className="bg-transparent text-xs focus:outline-none w-40" />
                </div>
                <div className="text-[10px] font-bold border line-green line-green-border px-3 py-1 uppercase">Admin: {userProfile?.displayName}</div>
              </div>
            </header>

            <div className="flex-1 overflow-auto p-8">
              {loading ? (
                <div className="flex items-center justify-center h-64 text-gray-300 font-bold animate-pulse italic">資料同步中...</div>
              ) : editingItem ? (
                /* --- Ragic 詳細編輯 (0 圓角、高密度) --- */
                <div className="animate-in fade-in duration-200 flex flex-col h-full">
                  <div className="mb-6 flex justify-between items-center">
                    <button onClick={() => setEditingItem(null)} className="px-4 py-2 bg-white border border-gray-300 text-xs font-bold hover:bg-gray-50 flex items-center"><Icon name="chevronLeft" size={14} className="mr-2" />返回</button>
                    <button className="line-green-bg text-white px-10 py-2 text-xs font-bold shadow-sm flex items-center"><Icon name="save" size={14} className="mr-2" />儲存變更</button>
                  </div>
                  <div className="bg-white border border-gray-200">
                    <div className="bg-gray-50 border-b border-gray-200 p-4 font-bold text-[10px] text-gray-400 uppercase tracking-widest">Detail Grid View</div>
                    <div className="detail-grid">
                      {Object.keys(editingItem).map(k => (
                        <div key={k} className="detail-cell">
                          <div className="detail-label">{k}</div>
                          <div className="flex-1 bg-white">
                            <input className="detail-input" value={editingItem[k]||''} onChange={e=>setEditingItem({...editingItem,[k]:e.target.value})} disabled={k.includes('序號')||k.includes('編號')||k==='userid'} />
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              ) : activeTab === 'dashboard' ? (
                /* --- Dashboard 與 上下收合 --- */
                <div className="flex flex-col space-y-8">
                  <div className="flex items-center justify-between">
                    <h2 className="text-2xl font-bold text-gray-800">數據分析中心</h2>
                    <button onClick={() => setStatsExpanded(!isStatsExpanded)} className="px-3 py-1.5 bg-white border border-gray-300 text-[11px] font-bold text-gray-500 flex items-center hover:line-green">
                      {isStatsExpanded ? "收合數據" : "展開數據"}<Icon name={isStatsExpanded ? "chevronUp" : "chevronDown"} size={14} className="ml-2" />
                    </button>
                  </div>
                  <div className={`grid grid-cols-1 md:grid-cols-4 gap-6 collapsible-stats ${isStatsExpanded ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'}`}>
                    <StatCard title="本業會員" value={stats.association} label="Active Users" />
                    <StatCard title="廠商會員" value={stats.vendor} label="Partners" />
                    <StatCard title="一般註冊" value={stats.general} label="Followers" />
                    <StatCard title="活動總計" value={stats.activities} label="Events" />
                  </div>
                  <div className="bg-white border border-gray-200 border-dashed p-20 flex flex-col items-center justify-center text-gray-100">
                    <Icon name="home" size={80} /><p className="mt-4 text-gray-300 font-bold tracking-[0.5em] uppercase">Welcome Back Manager</p>
                  </div>
                </div>
              ) : (
                /* --- 名冊清單 --- */
                <div className="bg-white border border-gray-200 flex flex-col h-full">
                  <div className="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50/30">
                    <span className="text-[11px] font-black text-gray-400 uppercase tracking-widest">總表 (共 {data.length} 筆)</span>
                    <button className="line-green-bg text-white px-5 py-1.5 text-xs font-bold">+ 新增資料</button>
                  </div>
                  <div className="overflow-auto flex-1">
                    <table className="crm-table">
                      <thead><tr>{data.length > 0 && Object.keys(data[0]).filter(k => k !== 'MAIL').slice(0, 10).map(k => <th key={k}>{k}</th>)}<th className="text-center sticky right-0 bg-gray-50 border-l border-gray-200">操作</th></tr></thead>
                      <tbody>{data.map((r, i) => (<tr key={i}>{Object.keys(r).filter(k => k !== 'MAIL').slice(0, 10).map((k, j) => <td key={j}>{String(r[k])}</td>)}<td className="text-center sticky right-0 bg-white border-l border-gray-200"><button onClick={() => setEditingItem(r)} className="line-green font-bold text-xs hover:underline px-4 py-2">編輯詳細</button></td></tr>))}</tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          </main>
        </div>
      );
    };

    const SidebarLink = ({ label, icon, active, collapsed, onClick }) => (
      <button onClick={onClick} className={`w-full flex items-center py-4 sidebar-item ${active ? 'sidebar-active shadow-sm' : ''} ${collapsed ? 'justify-center' : 'px-6'}`}>
        <Icon name={icon} size={20} className={collapsed ? '' : 'mr-3'} />
        {!collapsed && <span className="text-sm tracking-tight">{label}</span>}
      </button>
    );

    const StatCard = ({ title, value, label }) => (
      <div className="bg-white border border-gray-200 p-6 border-l-4 border-l-[#06C755]">
        <div className="text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-1">{title}</div>
        <div className="text-3xl font-black text-gray-800 mb-1">{value.toLocaleString()}</div>
        <div className="text-[10px] text-gray-400 font-medium uppercase">{label}</div>
      </div>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
